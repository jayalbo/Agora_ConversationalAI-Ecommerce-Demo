{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/components/ProductImages.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from 'react';\n\ninterface ProductImagesProps {\n  images: string[];\n}\n\nexport function ProductImages({ images }: ProductImagesProps) {\n  const [selectedImage, setSelectedImage] = useState(0);\n\n  return (\n    <div className=\"bg-white rounded-xl shadow-md border border-gray-100 p-6\">\n      <div className=\"relative aspect-square mb-6 bg-gray-50 rounded-lg overflow-hidden\">\n        <img\n          src={images[selectedImage]}\n          alt=\"Product\"\n          className=\"w-full h-full object-contain transition-opacity duration-300\"\n        />\n      </div>\n      <div className=\"flex gap-3 overflow-x-auto pb-2\">\n        {images.map((img, idx) => (\n          <button\n            key={idx}\n            onClick={() => setSelectedImage(idx)}\n            className={`flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden border-2 transition-all ${\n              selectedImage === idx \n                ? 'border-blue-600 ring-4 ring-blue-100 shadow-md scale-105' \n                : 'border-gray-200 hover:border-gray-400 hover:shadow-sm'\n            }`}\n          >\n            <img\n              src={img}\n              alt={`Product view ${idx + 1}`}\n              className=\"w-full h-full object-cover\"\n            />\n          </button>\n        ))}\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":";;;;;AAEA;;;AAFA;;AAQO,SAAS,cAAc,EAAE,MAAM,EAAsB;;IAC1D,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,yKAAQ,EAAC;IAEnD,qBACE,6LAAC;QAAI,WAAU;;0BACb,6LAAC;gBAAI,WAAU;0BACb,cAAA,6LAAC;oBACC,KAAK,MAAM,CAAC,cAAc;oBAC1B,KAAI;oBACJ,WAAU;;;;;;;;;;;0BAGd,6LAAC;gBAAI,WAAU;0BACZ,OAAO,GAAG,CAAC,CAAC,KAAK,oBAChB,6LAAC;wBAEC,SAAS,IAAM,iBAAiB;wBAChC,WAAW,CAAC,2EAA2E,EACrF,kBAAkB,MACd,6DACA,yDACJ;kCAEF,cAAA,6LAAC;4BACC,KAAK;4BACL,KAAK,CAAC,aAAa,EAAE,MAAM,GAAG;4BAC9B,WAAU;;;;;;uBAXP;;;;;;;;;;;;;;;;AAkBjB;GAjCgB;KAAA"}},
    {"offset": {"line": 78, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/components/ProductReviews.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\n\ninterface Review {\n  id: number;\n  userName: string;\n  rating: number;\n  date: string;\n  title: string;\n  comment: string;\n  verified: boolean;\n}\n\ninterface ProductReviewsProps {\n  reviews: Review[];\n  rating: number;\n}\n\nconst REVIEWS_PER_PAGE = 5;\n\nexport function ProductReviews({ reviews, rating }: ProductReviewsProps) {\n  const [currentPage, setCurrentPage] = useState(1);\n  const totalPages = Math.ceil(reviews.length / REVIEWS_PER_PAGE);\n  const startIndex = (currentPage - 1) * REVIEWS_PER_PAGE;\n  const endIndex = startIndex + REVIEWS_PER_PAGE;\n  const currentReviews = reviews.slice(startIndex, endIndex);\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-sm p-6 mt-8\">\n      <div className=\"flex items-center justify-between mb-6\">\n        <h2 className=\"text-2xl font-semibold\">Customer Reviews</h2>\n        <div className=\"text-right\">\n          <div className=\"text-3xl font-bold text-gray-900\">{rating}</div>\n          <div className=\"text-sm text-gray-600\">out of 5</div>\n        </div>\n      </div>\n      <div className=\"space-y-6\">\n        {currentReviews.map((review) => (\n          <div key={review.id} className=\"border-b pb-6 last:border-b-0\">\n            <div className=\"flex items-start justify-between mb-2\">\n              <div className=\"flex-1\">\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <span className=\"font-semibold text-gray-900\">\n                    {review.userName}\n                  </span>\n                  {review.verified && (\n                    <span className=\"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded\">\n                      Verified Purchase\n                    </span>\n                  )}\n                </div>\n                <div className=\"flex items-center gap-2 mt-1\">\n                  <span className=\"text-yellow-400\">\n                    {\"★\".repeat(review.rating)}\n                    {\"☆\".repeat(5 - review.rating)}\n                  </span>\n                  <span className=\"text-sm text-gray-500\">{review.date}</span>\n                </div>\n              </div>\n            </div>\n            <h4 className=\"font-medium mt-2 text-gray-900\">{review.title}</h4>\n            <p className=\"text-gray-700 mt-1 leading-relaxed\">\n              {review.comment}\n            </p>\n          </div>\n        ))}\n      </div>\n      \n      {/* Pagination */}\n      {totalPages > 1 && (\n        <div className=\"flex items-center justify-between mt-6 pt-6 border-t\">\n          <div className=\"text-sm text-gray-600\">\n            Showing {startIndex + 1}-{Math.min(endIndex, reviews.length)} of {reviews.length} reviews\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <button\n              onClick={() => setCurrentPage((prev) => Math.max(1, prev - 1))}\n              disabled={currentPage === 1}\n              className=\"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition\"\n            >\n              Previous\n            </button>\n            <div className=\"flex items-center gap-1\">\n              {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (\n                <button\n                  key={page}\n                  onClick={() => setCurrentPage(page)}\n                  className={`px-3 py-1 text-sm font-medium rounded ${\n                    currentPage === page\n                      ? \"bg-blue-600 text-white\"\n                      : \"text-gray-700 bg-white border border-gray-300 hover:bg-gray-50\"\n                  } transition`}\n                >\n                  {page}\n                </button>\n              ))}\n            </div>\n            <button\n              onClick={() => setCurrentPage((prev) => Math.min(totalPages, prev + 1))}\n              disabled={currentPage === totalPages}\n              className=\"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition\"\n            >\n              Next\n            </button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;;;AAFA;;AAmBA,MAAM,mBAAmB;AAElB,SAAS,eAAe,EAAE,OAAO,EAAE,MAAM,EAAuB;;IACrE,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,yKAAQ,EAAC;IAC/C,MAAM,aAAa,KAAK,IAAI,CAAC,QAAQ,MAAM,GAAG;IAC9C,MAAM,aAAa,CAAC,cAAc,CAAC,IAAI;IACvC,MAAM,WAAW,aAAa;IAC9B,MAAM,iBAAiB,QAAQ,KAAK,CAAC,YAAY;IAEjD,qBACE,6LAAC;QAAI,WAAU;;0BACb,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAG,WAAU;kCAAyB;;;;;;kCACvC,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCAAI,WAAU;0CAAoC;;;;;;0CACnD,6LAAC;gCAAI,WAAU;0CAAwB;;;;;;;;;;;;;;;;;;0BAG3C,6LAAC;gBAAI,WAAU;0BACZ,eAAe,GAAG,CAAC,CAAC,uBACnB,6LAAC;wBAAoB,WAAU;;0CAC7B,6LAAC;gCAAI,WAAU;0CACb,cAAA,6LAAC;oCAAI,WAAU;;sDACb,6LAAC;4CAAI,WAAU;;8DACb,6LAAC;oDAAK,WAAU;8DACb,OAAO,QAAQ;;;;;;gDAEjB,OAAO,QAAQ,kBACd,6LAAC;oDAAK,WAAU;8DAAsD;;;;;;;;;;;;sDAK1E,6LAAC;4CAAI,WAAU;;8DACb,6LAAC;oDAAK,WAAU;;wDACb,IAAI,MAAM,CAAC,OAAO,MAAM;wDACxB,IAAI,MAAM,CAAC,IAAI,OAAO,MAAM;;;;;;;8DAE/B,6LAAC;oDAAK,WAAU;8DAAyB,OAAO,IAAI;;;;;;;;;;;;;;;;;;;;;;;0CAI1D,6LAAC;gCAAG,WAAU;0CAAkC,OAAO,KAAK;;;;;;0CAC5D,6LAAC;gCAAE,WAAU;0CACV,OAAO,OAAO;;;;;;;uBAxBT,OAAO,EAAE;;;;;;;;;;YA+BtB,aAAa,mBACZ,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAI,WAAU;;4BAAwB;4BAC5B,aAAa;4BAAE;4BAAE,KAAK,GAAG,CAAC,UAAU,QAAQ,MAAM;4BAAE;4BAAK,QAAQ,MAAM;4BAAC;;;;;;;kCAEnF,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCACC,SAAS,IAAM,eAAe,CAAC,OAAS,KAAK,GAAG,CAAC,GAAG,OAAO;gCAC3D,UAAU,gBAAgB;gCAC1B,WAAU;0CACX;;;;;;0CAGD,6LAAC;gCAAI,WAAU;0CACZ,MAAM,IAAI,CAAC;oCAAE,QAAQ;gCAAW,GAAG,CAAC,GAAG,IAAM,IAAI,GAAG,GAAG,CAAC,CAAC,qBACxD,6LAAC;wCAEC,SAAS,IAAM,eAAe;wCAC9B,WAAW,CAAC,sCAAsC,EAChD,gBAAgB,OACZ,2BACA,iEACL,WAAW,CAAC;kDAEZ;uCARI;;;;;;;;;;0CAYX,6LAAC;gCACC,SAAS,IAAM,eAAe,CAAC,OAAS,KAAK,GAAG,CAAC,YAAY,OAAO;gCACpE,UAAU,gBAAgB;gCAC1B,WAAU;0CACX;;;;;;;;;;;;;;;;;;;;;;;;AAQb;GAzFgB;KAAA"}},
    {"offset": {"line": 332, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/hooks/useAgora.ts"],"sourcesContent":["\"use client\";\n\nimport { useState, useEffect, useRef } from \"react\";\n\ninterface UseAgoraProps {\n  appId: string;\n  channel: string;\n  token: string;\n  uid: number;\n}\n\nexport function useAgora({ appId, channel, token, uid }: UseAgoraProps) {\n  const [isConnected, setIsConnected] = useState(false);\n  const [isMuted, setIsMuted] = useState(false); // Microphone enabled by default (not muted)\n  const [localAudioTrack, setLocalAudioTrack] = useState<any>(null);\n  const [remoteAudioTrack, setRemoteAudioTrack] = useState<any>(null);\n  const [remoteVideoTrack, setRemoteVideoTrack] = useState<any>(null);\n  const clientRef = useRef<any>(null);\n  const virtualBackgroundExtensionRef = useRef<any>(null);\n  const virtualBackgroundProcessorRef = useRef<any>(null);\n\n  useEffect(() => {\n    // Don't initialize if we don't have valid config or if we're on the server\n    if (\n      typeof window === \"undefined\" ||\n      !appId ||\n      !channel ||\n      !token ||\n      uid === 0 ||\n      !appId.trim() ||\n      !channel.trim() ||\n      !token.trim()\n    ) {\n      return;\n    }\n\n    let isMounted = true;\n    let audioTrack: any = null;\n    let client: any = null;\n\n    const init = async () => {\n      try {\n        // Dynamically import AgoraRTC only on the client\n        const AgoraRTC = (await import(\"agora-rtc-sdk-ng\")).default;\n        // Enable audio PTS metadata for Conversational AI (REQUIRED for ASR to work!)\n        // This must be set BEFORE creating the client\n        (AgoraRTC as any).setParameter(\"ENABLE_AUDIO_PTS_METADATA\", true);\n\n        // Register Virtual Background Extension\n        try {\n          const VirtualBackgroundExtension = (\n            await import(\"agora-extension-virtual-background\")\n          ).default;\n\n          if (VirtualBackgroundExtension) {\n            const extension = new VirtualBackgroundExtension();\n            if (extension.checkCompatibility()) {\n              AgoraRTC.registerExtensions([extension]);\n              virtualBackgroundExtensionRef.current = extension;\n              console.log(\"[useAgora] Virtual Background Extension registered\");\n            } else {\n              console.warn(\n                \"[useAgora] Virtual Background Extension not supported in this browser\"\n              );\n            }\n          }\n        } catch (extError) {\n          console.warn(\n            \"[useAgora] Failed to load virtual background extension:\",\n            extError\n          );\n        }\n\n        client = AgoraRTC.createClient({ mode: \"rtc\", codec: \"vp8\" });\n        clientRef.current = client;\n\n        // Join the channel\n        await client.join(appId, channel, token, uid);\n\n        if (!isMounted) {\n          // Component unmounted during join, cleanup\n          await client.leave().catch(() => {});\n          return;\n        }\n\n        setIsConnected(true);\n\n        // Create and publish local audio track\n        audioTrack = await AgoraRTC.createMicrophoneAudioTrack();\n\n        if (!isMounted) {\n          // Component unmounted during track creation, cleanup\n          audioTrack.close();\n          await client.leave().catch(() => {});\n          return;\n        }\n\n        await client.publish([audioTrack]);\n        setLocalAudioTrack(audioTrack);\n\n        // Listen for remote audio and video tracks\n        client.on(\"user-published\", async (user: any, mediaType: string) => {\n          if (isMounted) {\n            try {\n              await client!.subscribe(user, mediaType);\n\n              if (mediaType === \"audio\") {\n                const remoteTrack = user.audioTrack;\n                if (remoteTrack && isMounted) {\n                  setRemoteAudioTrack(remoteTrack);\n                  // Wait a bit to ensure track is fully ready before playing\n                  // This prevents race condition where audio doesn't play on first load\n                  setTimeout(() => {\n                    if (isMounted && remoteTrack) {\n                      try {\n                        const playResult = remoteTrack.play();\n                        // play() might return a promise or undefined\n                        if (\n                          playResult &&\n                          typeof playResult.catch === \"function\"\n                        ) {\n                          playResult.catch((error: any) => {\n                            console.error(\n                              \"Error playing remote audio track:\",\n                              error\n                            );\n                          });\n                        }\n                      } catch (error: any) {\n                        console.error(\n                          \"Error playing remote audio track:\",\n                          error\n                        );\n                      }\n                    }\n                  }, 100);\n                }\n              } else if (mediaType === \"video\") {\n                const remoteTrack = user.videoTrack;\n                if (remoteTrack && isMounted) {\n                  // Apply virtual background extension with green color to remote video track\n                  try {\n                    if (virtualBackgroundExtensionRef.current) {\n                      // Create processor for remote video track\n                      const processor =\n                        virtualBackgroundExtensionRef.current.createProcessor();\n\n                      // Initialize the processor\n                      await processor.init();\n\n                      // For remote tracks, use insertProcessor method\n                      if (typeof remoteTrack.insertProcessor === \"function\") {\n                        remoteTrack.insertProcessor(processor);\n\n                        // Set green background color (RGB: 0, 255, 0)\n                        await processor.setOptions({\n                          type: \"color\",\n                          color: \"#00FF00\", // Green color in hex\n                        });\n\n                        // Enable the processor\n                        await processor.enable();\n\n                        virtualBackgroundProcessorRef.current = processor;\n                        console.log(\n                          \"[useAgora] Virtual background with green color applied to remote video using insertProcessor\"\n                        );\n                      } else if (\n                        remoteTrack.pipe &&\n                        remoteTrack.processorDestination\n                      ) {\n                        // Fallback: try pipe method (typically for local tracks)\n                        remoteTrack\n                          .pipe(processor)\n                          .pipe(remoteTrack.processorDestination);\n                        await processor.setOptions({\n                          type: \"color\",\n                          color: \"#00FF00\",\n                        });\n                        await processor.enable();\n                        virtualBackgroundProcessorRef.current = processor;\n                        console.log(\n                          \"[useAgora] Virtual background applied using pipe method\"\n                        );\n                      } else {\n                        console.warn(\n                          \"[useAgora] Remote video track does not support processors\"\n                        );\n                        processor.destroy();\n                      }\n                    }\n                  } catch (bgError) {\n                    console.error(\n                      \"[useAgora] Failed to apply virtual background:\",\n                      bgError\n                    );\n                  }\n\n                  setRemoteVideoTrack(remoteTrack);\n                }\n              }\n            } catch (error) {\n              console.error(`Error subscribing to remote ${mediaType}:`, error);\n            }\n          }\n        });\n\n        client.on(\"user-unpublished\", (user: any, mediaType: string) => {\n          if (isMounted) {\n            if (mediaType === \"audio\") {\n              setRemoteAudioTrack(null);\n            } else if (mediaType === \"video\") {\n              const remoteTrack = user.videoTrack;\n              if (remoteTrack) {\n                // Clean up virtual background processor if it exists\n                if (virtualBackgroundProcessorRef.current) {\n                  try {\n                    virtualBackgroundProcessorRef.current.disable();\n                    virtualBackgroundProcessorRef.current.destroy();\n                  } catch (e) {\n                    // Ignore cleanup errors\n                  }\n                  virtualBackgroundProcessorRef.current = null;\n                }\n                remoteTrack.stop();\n              }\n              setRemoteVideoTrack(null);\n            }\n          }\n        });\n      } catch (error: any) {\n        // Ignore OPERATION_ABORTED errors (happens when component unmounts during init)\n        if (error?.code !== \"OPERATION_ABORTED\" && isMounted) {\n          console.error(\"Agora initialization error:\", error);\n        }\n        if (isMounted) {\n          setIsConnected(false);\n        }\n      }\n    };\n\n    init();\n\n    return () => {\n      isMounted = false;\n\n      // Cleanup\n      if (audioTrack) {\n        audioTrack.close();\n        audioTrack = null;\n      }\n\n      // Clean up virtual background processor\n      if (virtualBackgroundProcessorRef.current) {\n        try {\n          virtualBackgroundProcessorRef.current.disable();\n          virtualBackgroundProcessorRef.current.destroy();\n        } catch (e) {\n          // Ignore cleanup errors\n        }\n        virtualBackgroundProcessorRef.current = null;\n      }\n\n      if (clientRef.current) {\n        const currentClient = clientRef.current;\n        // Clean up video tracks before leaving\n        currentClient.remoteUsers?.forEach((user: any) => {\n          if (user.videoTrack) {\n            user.videoTrack.stop();\n          }\n        });\n        clientRef.current = null;\n        currentClient.leave().catch(() => {\n          // Ignore errors during cleanup\n        });\n      }\n\n      setIsConnected(false);\n      setLocalAudioTrack(null);\n      setRemoteAudioTrack(null);\n      setRemoteVideoTrack(null);\n    };\n  }, [appId, channel, token, uid]);\n\n  const toggleMute = async () => {\n    if (localAudioTrack) {\n      await localAudioTrack.setMuted(!isMuted);\n      setIsMuted(!isMuted);\n    }\n  };\n\n  const leave = async () => {\n    if (localAudioTrack) {\n      localAudioTrack.close();\n      setLocalAudioTrack(null);\n    }\n    if (clientRef.current) {\n      await clientRef.current.leave();\n      setIsConnected(false);\n    }\n  };\n\n  return {\n    isConnected,\n    isMuted,\n    toggleMute,\n    leave,\n    localAudioTrack,\n    remoteAudioTrack,\n    remoteVideoTrack,\n    client: clientRef.current,\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 615, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/lib/conversational-ai-api/type.ts"],"sourcesContent":["import type {\n  ConnectionDisconnectedReason,\n  ConnectionState,\n  IAgoraRTCRemoteUser,\n  ICameraVideoTrack,\n  IMicrophoneAudioTrack,\n  NetworkQuality,\n  UID\n} from 'agora-rtc-sdk-ng'\nimport type { RTMEvents } from 'agora-rtm-sdk'\n\n/**\n * Transcript modes for the Conversational AI API\n *\n * @description\n * Defines the different modes available for transcript processing and display.\n * Used to determine how transcription data should be handled and presented.\n *\n * @remarks\n * - All modes are string literals for easy serialization\n * - Modes determine the granularity of transcript processing\n * - TEXT should be used as a fallback for unrecognized modes\n *\n * Values include:\n * - TEXT: Plain text mode for simple transcript display\n * - WORD: Word-level processing with individual word tracking\n * - CHUNK: Chunk-based processing for grouped text segments\n * - UNKNOWN: Initial mode for unrecognized transcript types\n *\n * @since 1.6.0\n */\nexport enum ETranscriptHelperMode {\n  TEXT = 'text',\n  WORD = 'word',\n  CHUNK = 'chunk',\n  UNKNOWN = 'unknown'\n}\n\nexport enum EMessageType {\n  USER_TRANSCRIPTION = 'user.transcription',\n  AGENT_TRANSCRIPTION = 'assistant.transcription',\n  MSG_INTERRUPTED = 'message.interrupt',\n  MSG_METRICS = 'message.metrics',\n  MSG_ERROR = 'message.error',\n  /** @deprecated */\n  MSG_STATE = 'message.state',\n  IMAGE_UPLOAD = 'image.upload',\n  MESSAGE_INFO = 'message.info',\n  MESSAGE_SAL_STATUS = 'message.sal_status'\n}\n\nexport enum ERTMEvents {\n  MESSAGE = 'message',\n  PRESENCE = 'presence',\n  // TOPIC = 'topic',\n  // STORAGE = 'storage',\n  // LOCK = 'lock',\n  STATUS = 'status'\n  // LINK_STATE = 'linkState',\n  // TOKEN_PRIVILEGE_WILL_EXPIRE = 'tokenPrivilegeWillExpire',\n}\n\nexport enum ERTCEvents {\n  NETWORK_QUALITY = 'network-quality',\n  USER_PUBLISHED = 'user-published',\n  USER_UNPUBLISHED = 'user-unpublished',\n  STREAM_MESSAGE = 'stream-message',\n  USER_JOINED = 'user-joined',\n  USER_LEFT = 'user-left',\n  CONNECTION_STATE_CHANGE = 'connection-state-change',\n  // AUDIO_METADATA = 'audio-metadata',\n  AUDIO_PTS = 'audio-pts'\n}\n\nexport enum ERTCCustomEvents {\n  MICROPHONE_CHANGED = 'microphone-changed',\n  REMOTE_USER_CHANGED = 'remote-user-changed',\n  REMOTE_USER_JOINED = 'remote-user-joined',\n  REMOTE_USER_LEFT = 'remote-user-left',\n  LOCAL_TRACKS_CHANGED = 'local-tracks-changed'\n}\n\n/**\n * Event types for the Conversational AI API\n *\n * @description\n * Defines the event types that can be emitted by the Conversational AI API.\n * Contains events for agent state changes, interruptions, metrics, errors, transcription updates, debug logs, and message receipt updates.\n *\n * @remarks\n * - All events are string literals and can be used with event listeners\n * - Events are case-sensitive\n *\n * Values include:\n * - AGENT_STATE_CHANGED: Agent state change events\n * - AGENT_INTERRUPTED: Agent interruption events\n * - AGENT_METRICS: Agent performance metrics\n * - AGENT_ERROR: Agent error events\n * - TRANSCRIPT_UPDATED: Transcription update events\n * - DEBUG_LOG: Debug logging events\n * - MESSAGE_RECEIPT_UPDATED: Message receipt update events\n * - MESSAGE_ERROR: Message error events\n *\n * @since 1.6.0\n */\nexport enum EConversationalAIAPIEvents {\n  AGENT_STATE_CHANGED = 'agent-state-changed',\n  AGENT_INTERRUPTED = 'agent-interrupted',\n  AGENT_METRICS = 'agent-metrics',\n  AGENT_ERROR = 'agent-error',\n  TRANSCRIPT_UPDATED = 'transcript-updated',\n  DEBUG_LOG = 'debug-log',\n  MESSAGE_RECEIPT_UPDATED = 'message-receipt-updated',\n  MESSAGE_ERROR = 'message-error',\n  MESSAGE_SAL_STATUS = 'message-sal-status'\n}\n\n/**\n * Module type enumeration for AI capabilities\n *\n * Defines the different types of AI modules available in the system, including language models and text-to-speech\n *\n * @remarks\n * - Each enum value represents a distinct AI capability module\n * - Use these values to specify module type in API calls\n *\n * Values include:\n * - LLM: Language Learning Model\n * - MLLM: Multimodal Language Learning Model\n * - TTS: Text-to-Speech\n * - CONTEXT: Context management module\n * - UNKNOWN: Unknown module type\n *\n * @since 1.6.0\n */\nexport enum EModuleType {\n  LLM = 'llm',\n  MLLM = 'mllm',\n  TTS = 'tts',\n  CONTEXT = 'context',\n  UNKNOWN = 'unknown'\n}\n\n/**\n * Agent metrics statistics data type definition\n *\n * @description\n * Used to store metric data during AI agent runtime, including type, name, value and timestamp\n *\n * @param type - Metric module type {@link EModuleType}\n * @param name - Metric name\n * @param value - Metric value\n * @param timestamp - Data collection timestamp (milliseconds)\n *\n * @since 1.6.0\n */\nexport type TAgentMetric = {\n  type: EModuleType\n  name: string\n  value: number\n  timestamp: number\n}\n\n/**\n * Message receipt type definition\n *\n * @description\n * Represents a message receipt from the AI module, including type, message content and turn ID\n *\n * @param moduleType - The module type that sent the message {@link EModuleType}\n * @param messageType - The type of the message {@link EChatMessageType}\n * @param message - The content of the message\n * @param turnId - Unique identifier for the conversation turn\n *\n * @since 1.7.0\n */\nexport type TMessageReceipt = {\n  moduleType: EModuleType\n  messageType: EChatMessageType\n  message: string\n  turnId: number\n}\n\n/**\n * Module error type definition\n *\n * @description\n * Represents error information from different AI modules including error type, code,\n * message and timestamp. Used for error handling and debugging.\n *\n * @remarks\n * - Error codes are module-specific and should be documented by each module\n * - Timestamp is in Unix milliseconds format\n * - Error messages should be human readable and provide actionable information\n *\n * @param type - The module type where error occurred {@link EModuleType}\n * @param code - Error code specific to the module\n * @param message - Human readable error description\n * @param timestamp - Unix timestamp in milliseconds when error occurred\n *\n * @since 1.6.0\n */\nexport type TModuleError = {\n  type: EModuleType\n  code: number\n  message: string\n  timestamp: number\n}\n\n/**\n * Type definition for state change event\n *\n * Used to describe the information related to voice agent state changes, including current state, turn ID, timestamp and reason\n *\n * @param state Current state of the voice agent. See {@link EAgentState}\n * @param turnID Unique identifier for the current conversation turn\n * @param timestamp Timestamp when the state change occurred (in milliseconds)\n * @param reason Reason description for the state change\n *\n * @since 1.6.0\n *\n * @remarks\n * - State change events are triggered when the voice agent's state changes\n * - timestamp uses UNIX timestamp (in milliseconds)\n */\nexport type TStateChangeEvent = {\n  state: EAgentState\n  turnID: number\n  timestamp: number\n  reason: string\n}\n\n/**\n * Event handlers interface for the Conversational AI API module.\n *\n * @since 1.6.0\n *\n * Defines a set of event handlers that can be implemented to respond to various\n * events emitted by the Conversational AI system, including agent state changes,\n * interruptions, metrics, errors, and transcription updates.\n *\n * @remarks\n * - All handlers are required to be implemented when using this interface\n * - Events are emitted asynchronously and should be handled accordingly\n * - Event handlers should be lightweight to avoid blocking the event loop\n * - Error handling should be implemented within each handler to prevent crashes\n *\n * @example\n * ```typescript\n * const handlers: IConversationalAIAPIEventHandlers = {\n *   [EConversationalAIAPIEvents.AGENT_STATE_CHANGED]: (agentUserId, event) => {\n *     console.log(`Agent ${agentUserId} state changed:`, event);\n *   },\n *   // ... implement other handlers\n * };\n * ```\n *\n * @param agentUserId - The unique identifier of the AI agent\n * @param event - Event data specific to each event type\n * @param metrics - Performance metrics data for the agent\n * @param error - Error information when agent encounters issues\n * @param transcription - Array of transcription items containing user and agent dialogue\n * @param message - Debug log message string\n * @param messageReceipt - Updated message receipt information\n * @param messageError - Error information related to a specific message\n *\n * @see {@link EConversationalAIAPIEvents} for all available event types\n * @see {@link TStateChangeEvent} for state change event structure\n * @see {@link TAgentMetric} for agent metrics structure\n * @see {@link TModuleError} for error structure\n * @see {@link ITranscriptHelperItem} for transcription item structure\n * @see {@link TMessageReceipt} for message receipt structure\n * @see {@link EChatMessageType} for message type enumeration\n */\nexport interface IConversationalAIAPIEventHandlers {\n  [EConversationalAIAPIEvents.AGENT_STATE_CHANGED]: (\n    agentUserId: string,\n    event: TStateChangeEvent\n  ) => void\n  [EConversationalAIAPIEvents.AGENT_INTERRUPTED]: (\n    agentUserId: string,\n    event: {\n      turnID: number\n      timestamp: number\n    }\n  ) => void\n  [EConversationalAIAPIEvents.AGENT_METRICS]: (\n    agentUserId: string,\n    metrics: TAgentMetric\n  ) => void\n  [EConversationalAIAPIEvents.AGENT_ERROR]: (\n    agentUserId: string,\n    error: TModuleError\n  ) => void\n  [EConversationalAIAPIEvents.TRANSCRIPT_UPDATED]: (\n    transcription: ITranscriptHelperItem<\n      Partial<IUserTranscription | IAgentTranscription>\n    >[]\n  ) => void\n  [EConversationalAIAPIEvents.DEBUG_LOG]: (message: string) => void\n  [EConversationalAIAPIEvents.MESSAGE_RECEIPT_UPDATED]: (\n    agentUserId: string,\n    messageReceipt: TMessageReceipt\n  ) => void\n  [EConversationalAIAPIEvents.MESSAGE_ERROR]: (\n    agentUserId: string,\n    error: {\n      type: EChatMessageType\n      code: number\n      message: string\n      timestamp: number\n    }\n  ) => void\n  [EConversationalAIAPIEvents.MESSAGE_SAL_STATUS]: (\n    agentUserId: string,\n    salStatus: IMessageSalStatus\n  ) => void\n}\n\n// export interface IHelperRTMEvents {\n//   [ERTMEvents.MESSAGE]: (message: RTMEvents.MessageEvent) => void\n//   [ERTMEvents.PRESENCE]: (message: RTMEvents.PresenceEvent) => void\n//   [ERTMEvents.STATUS]: (\n//     message: RTMEvents.RTMConnectionStatusChangeEvent\n//   ) => void\n// }\n\nexport interface IHelperRTCEvents {\n  [ERTCEvents.NETWORK_QUALITY]: (quality: NetworkQuality) => void\n  [ERTCEvents.USER_PUBLISHED]: (\n    user: IAgoraRTCRemoteUser,\n    mediaType: 'audio' | 'video'\n  ) => void\n  [ERTCEvents.USER_UNPUBLISHED]: (\n    user: IAgoraRTCRemoteUser,\n    mediaType: 'audio' | 'video'\n  ) => void\n  [ERTCEvents.USER_JOINED]: (user: IAgoraRTCRemoteUser) => void\n  [ERTCEvents.USER_LEFT]: (user: IAgoraRTCRemoteUser, reason?: string) => void\n  [ERTCEvents.CONNECTION_STATE_CHANGE]: (data: {\n    curState: ConnectionState\n    revState: ConnectionState\n    reason?: ConnectionDisconnectedReason\n    channel: string\n  }) => void\n  // [ERTCEvents.AUDIO_METADATA]: (metadata: Uint8Array) => void @deprecated\n  [ERTCEvents.AUDIO_PTS]: (pts: number) => void\n  [ERTCEvents.STREAM_MESSAGE]: (uid: UID, stream: Uint8Array) => void\n}\n\nexport class NotFoundError extends Error {\n  constructor(message: string) {\n    super(message)\n    this.name = 'NotFoundError'\n  }\n}\n\n// --- Message ---\nexport type TDataChunkMessageWord = {\n  word: string\n  start_ms: number\n  duration_ms: number\n  stable: boolean\n}\n\nexport type TTranscriptHelperObjectWord = TDataChunkMessageWord & {\n  word_status?: ETurnStatus\n}\n\nexport enum ETurnStatus {\n  IN_PROGRESS = 0,\n  END = 1,\n  INTERRUPTED = 2\n}\n\n/**\n * Agent state enumeration\n *\n * Represents the different states of a conversational AI agent, including idle, listening, thinking, speaking and silent states\n *\n * Detailed Description:\n * This enum is used to track and manage the current state of an AI agent in a conversational system.\n * The states help coordinate the interaction flow between the user and the AI agent.\n *\n * States include:\n * - IDLE: Agent is ready for new interaction\n * - LISTENING: Agent is receiving user input\n * - THINKING: Agent is processing received input\n * - SPEAKING: Agent is delivering response\n * - SILENT: Agent is intentionally not responding\n *\n * @remarks\n * - State transitions should be handled properly to avoid deadlocks\n * - The SILENT state is different from IDLE as it represents an intentional non-response\n *\n * @since 1.6.0\n */\nexport enum EAgentState {\n  IDLE = 'idle',\n  LISTENING = 'listening',\n  THINKING = 'thinking',\n  SPEAKING = 'speaking',\n  SILENT = 'silent'\n}\n\nexport interface ITranscriptionBase {\n  object: EMessageType\n  text: string\n  start_ms: number\n  duration_ms: number\n  language: string\n  turn_id: number\n  stream_id: number\n  user_id: string\n  words: TDataChunkMessageWord[] | null\n}\n\nexport interface IUserTranscription extends ITranscriptionBase {\n  object: EMessageType.USER_TRANSCRIPTION // \"user.transcription\"\n  final: boolean\n}\n\nexport interface IAgentTranscription extends ITranscriptionBase {\n  object: EMessageType.AGENT_TRANSCRIPTION // \"assistant.transcription\"\n  quiet: boolean\n  turn_seq_id: number\n  turn_status: ETurnStatus\n}\n\nexport interface IMessageInterrupt {\n  object: EMessageType.MSG_INTERRUPTED // \"message.interrupt\"\n  message_id: string\n  data_type: 'message'\n  turn_id: number\n  start_ms: number\n  send_ts: number\n}\n\nexport interface IMessageMetrics {\n  object: EMessageType.MSG_METRICS // \"message.metrics\"\n  module: EModuleType\n  metric_name: string\n  turn_id: number\n  latency_ms: number\n  send_ts: number\n}\n\nexport interface IMessageError {\n  object: EMessageType.MSG_ERROR // \"message.error\"\n  module: EModuleType\n  code: number\n  message: string\n  turn_id: number\n  send_ts: number\n  [x: string]: unknown // Allow additional properties\n}\n\nexport interface IPresenceState\n  extends Omit<RTMEvents.PresenceEvent, 'stateChanged'> {\n  stateChanged: {\n    state: EAgentState\n    turn_id: string\n  }\n}\n\nexport type TQueueItem = {\n  turn_id: number\n  text: string\n  words: TTranscriptHelperObjectWord[]\n  status: ETurnStatus\n  stream_id: number\n  uid: string\n}\n\n/**\n * Interface for transcript helper item\n *\n * Defines the data structure for a single transcript item in the transcript system. Contains basic transcript information such as user ID, stream ID, turn ID, timestamp, text content, status, and metadata.\n *\n * @remarks\n * - This interface supports generics, allowing different types of metadata as needed\n * - Status value must be a valid value defined in {@link ETurnStatus}\n *\n * @param T - Type of metadata\n * @param uid - Unique identifier for the user\n * @param stream_id - Stream identifier\n * @param turn_id - Turn identifier in the conversation\n * @param _time - Timestamp of the transcript (in milliseconds)\n * @param text - Transcript text content\n * @param status - Current status of the transcript item\n * @param metadata - Additional metadata information\n *\n * @since 1.6.0\n */\nexport interface ITranscriptHelperItem<T> {\n  uid: string\n  stream_id: number\n  turn_id: number\n  _time: number\n  text: string\n  status: ETurnStatus\n  metadata: T | null\n}\n\n// --- rtc ---\nexport interface IUserTracks {\n  videoTrack?: ICameraVideoTrack\n  audioTrack?: IMicrophoneAudioTrack\n}\n\n// --- rtm ---\n\n/**\n * Enumeration defining chat message priority levels for handling message processing.\n *\n * Specifies how incoming chat messages should be handled when they arrive during\n * ongoing conversation processing, providing control over message queue behavior\n * and user experience during real-time interactions.\n *\n * @remarks\n * Values include:\n * - INTERRUPTED: Interrupt current processing and handle immediately\n * - APPEND: Add to processing queue for sequential handling\n * - IGNORE: Discard the message without processing\n *\n * @enum {string}\n *\n * @since 1.7.0\n */\nexport enum EChatMessagePriority {\n  INTERRUPTED = 'interrupted',\n  APPEND = 'append',\n  IGNORE = 'ignore'\n}\n\n/**\n * Enumeration defining the different types of chat messages supported in the conversational AI system.\n *\n * @remarks\n * Values include:\n * - TEXT: Text-based message\n * - IMAGE: Image-based message\n * - UNKNOWN: Unknown message type\n *\n * @enum {string}\n *\n * @since 1.7.0\n */\nexport enum EChatMessageType {\n  TEXT = 'text',\n  IMAGE = 'image',\n  UNKNOWN = 'unknown'\n}\n\n/**\n * Base interface for chat messages containing the fundamental message type property.\n * This interface serves as the foundation for all chat message types in the system.\n *\n * @since 1.7.0\n */\nexport interface IChatMessageBase {\n  messageType: EChatMessageType\n}\n\n/**\n * Represents a text-based chat message with priority and interruption settings.\n *\n * @interface IChatMessageText\n * @extends IChatMessageBase\n *\n * @property messageType - The type of message, must be TEXT\n * @property priority - The priority level of the chat message\n * @property responseInterruptable - Whether the response can be interrupted\n * @property text - The optional text content of the message\n *\n * @since 1.7.0\n */\nexport interface IChatMessageText extends IChatMessageBase {\n  messageType: EChatMessageType.TEXT\n  priority: EChatMessagePriority\n  responseInterruptable: boolean\n  text?: string\n}\n\n/**\n * Represents an image-based chat message that can contain either a URL or base64 encoded image data.\n *\n * @interface IChatMessageImage\n * @extends IChatMessageBase\n *\n * @property messageType - The type of message, must be IMAGE\n * @property uuid - Unique identifier for the image message\n * @property url - Optional URL pointing to the image resource\n * @property base64 - Optional base64 encoded image data\n */\nexport interface IChatMessageImage extends IChatMessageBase {\n  messageType: EChatMessageType.IMAGE\n  uuid: string\n  url?: string\n  base64?: string\n}\n\n// --- local ---\nexport enum ELocalTranscriptStatus {\n  PENDING = 'pending',\n  SENT = 'sent',\n  FAILED = 'failed'\n}\n\nexport interface ILocalTranscriptionBase {\n  id: string\n  uid: string\n  _time: number\n  status: ELocalTranscriptStatus\n}\n\nexport interface ILocalImageTranscription extends ILocalTranscriptionBase {\n  localImage: File\n  imageDimensions: {\n    width: number\n    height: number\n  }\n  image_url?: string\n}\n\nexport enum EMessageSalStatus {\n  VP_DISABLED = 'VP_DISABLED',\n  VP_UNREGISTER = 'VP_UNREGISTER',\n  VP_REGISTERING = 'VP_REGISTERING',\n  VP_REGISTER_SUCCESS = 'VP_REGISTER_SUCCESS',\n  VP_REGISTER_FAIL = 'VP_REGISTER_FAIL',\n  VP_REGISTER_DUPLICATE = 'VP_REGISTER_DUPLICATE'\n}\nexport interface IMessageSalStatus {\n  object: EMessageType.MESSAGE_SAL_STATUS // \"message.sal_status\"\n  status: EMessageSalStatus\n  timestamp: number\n  data_type: string\n  message_id: string\n  send_ts: number\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA+BO,IAAA,AAAK,+CAAA;;;;;WAAA;;AAOL,IAAA,AAAK,sCAAA;;;;;;IAMV,gBAAgB;;;;WANN;;AAaL,IAAA,AAAK,oCAAA;;;IAGV,mBAAmB;IACnB,uBAAuB;IACvB,iBAAiB;;WALP;;AAWL,IAAA,AAAK,oCAAA;;;;;;;;IAQV,qCAAqC;;WAR3B;;AAYL,IAAA,AAAK,0CAAA;;;;;;WAAA;;AA+BL,IAAA,AAAK,oDAAA;;;;;;;;;;WAAA;;AA8BL,IAAA,AAAK,qCAAA;;;;;;WAAA;;AAuNL,MAAM,sBAAsB;IACjC,YAAY,OAAe,CAAE;QAC3B,KAAK,CAAC;QACN,IAAI,CAAC,IAAI,GAAG;IACd;AACF;AAcO,IAAA,AAAK,qCAAA;;;;WAAA;;AA4BL,IAAA,AAAK,qCAAA;;;;;;WAAA;;AAoIL,IAAA,AAAK,8CAAA;;;;WAAA;;AAmBL,IAAA,AAAK,0CAAA;;;;WAAA;;AAuDL,IAAA,AAAK,gDAAA;;;;WAAA;;AAsBL,IAAA,AAAK,2CAAA;;;;;;;WAAA"}},
    {"offset": {"line": 767, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/lib/conversational-ai-api/utils/index.ts"],"sourcesContent":["// export const factoryFormatLog =\n//   (options: { tag: string }) => (message: unknown) => {\n//     return `[${options.tag}] ${JSON.stringify(message)}`\n//   }\nexport const factoryFormatLog =\n  (options: { tag: string }) =>\n  (...args: unknown[]) => {\n    return `[${options.tag}] ${args.map((arg) => JSON.stringify(arg)).join(' ')}`\n  }\n\nexport enum ELoggerType {\n  debug = 'debug',\n  info = 'info',\n  warn = 'warn',\n  error = 'error'\n}\n"],"names":[],"mappings":"AAAA,kCAAkC;AAClC,0DAA0D;AAC1D,2DAA2D;AAC3D,MAAM;;;;;;;AACC,MAAM,mBACX,CAAC,UACD,CAAC,GAAG;QACF,OAAO,CAAC,CAAC,EAAE,QAAQ,GAAG,CAAC,EAAE,EAAE,KAAK,GAAG,CAAC,CAAC,MAAQ,KAAK,SAAS,CAAC,MAAM,IAAI,CAAC,MAAM;IAC/E;AAEK,IAAA,AAAK,qCAAA;;;;;WAAA"}},
    {"offset": {"line": 794, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/lib/conversational-ai-api/utils/event.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n\ntype EventHandler<T extends any[]> = (...data: T) => void\n\nexport class EventHelper<T> {\n  private _eventMap: Map<keyof T, EventHandler<any[]>[]> = new Map()\n\n  once<Key extends keyof T>(evt: Key, cb: T[Key]) {\n    const wrapper = (...args: any[]) => {\n      this.off(evt, wrapper as any)\n      ;(cb as any)(...args)\n    }\n    this.on(evt, wrapper as any)\n    return this\n  }\n\n  on<Key extends keyof T>(evt: Key, cb: T[Key]) {\n    const cbs = this._eventMap.get(evt) ?? []\n    cbs.push(cb as any)\n    this._eventMap.set(evt, cbs)\n    console.debug(`Subscribed to event: ${String(evt)}`)\n    return this\n  }\n\n  off<Key extends keyof T>(evt: Key, cb: T[Key]) {\n    const cbs = this._eventMap.get(evt)\n    if (cbs) {\n      this._eventMap.set(\n        evt,\n        cbs.filter((it) => it !== cb)\n      )\n      console.debug(`Unsubscribed from event: ${String(evt)}`)\n    }\n    return this\n  }\n\n  removeAllEventListeners(): void {\n    this._eventMap.clear()\n    console.debug('Removed all event listeners')\n  }\n\n  emit<Key extends keyof T>(evt: Key, ...args: any[]) {\n    const cbs = this._eventMap.get(evt) ?? []\n    for (const cb of cbs) {\n      try {\n        // eslint-disable-next-line @typescript-eslint/no-unused-expressions\n        cb && cb(...args)\n      } catch (e) {\n        // cb exception should not affect other callbacks\n        const error = e as Error\n        const details = error.stack || error.message\n        console.error(`Error handling event ${String(evt)}: ${details}`)\n      }\n    }\n    console.debug({ args }, `Emitted event: ${String(evt)}`)\n    return this\n  }\n}\n"],"names":[],"mappings":"AAAA,qDAAqD;;;;AAI9C,MAAM;IACH,YAAiD,IAAI,MAAK;IAElE,KAA0B,GAAQ,EAAE,EAAU,EAAE;QAC9C,MAAM,UAAU,CAAC,GAAG;YAClB,IAAI,CAAC,GAAG,CAAC,KAAK;YACZ,MAAc;QAClB;QACA,IAAI,CAAC,EAAE,CAAC,KAAK;QACb,OAAO,IAAI;IACb;IAEA,GAAwB,GAAQ,EAAE,EAAU,EAAE;QAC5C,MAAM,MAAM,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,QAAQ,EAAE;QACzC,IAAI,IAAI,CAAC;QACT,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,KAAK;QACxB,QAAQ,KAAK,CAAC,CAAC,qBAAqB,EAAE,OAAO,MAAM;QACnD,OAAO,IAAI;IACb;IAEA,IAAyB,GAAQ,EAAE,EAAU,EAAE;QAC7C,MAAM,MAAM,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC;QAC/B,IAAI,KAAK;YACP,IAAI,CAAC,SAAS,CAAC,GAAG,CAChB,KACA,IAAI,MAAM,CAAC,CAAC,KAAO,OAAO;YAE5B,QAAQ,KAAK,CAAC,CAAC,yBAAyB,EAAE,OAAO,MAAM;QACzD;QACA,OAAO,IAAI;IACb;IAEA,0BAAgC;QAC9B,IAAI,CAAC,SAAS,CAAC,KAAK;QACpB,QAAQ,KAAK,CAAC;IAChB;IAEA,KAA0B,GAAQ,EAAE,GAAG,IAAW,EAAE;QAClD,MAAM,MAAM,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,QAAQ,EAAE;QACzC,KAAK,MAAM,MAAM,IAAK;YACpB,IAAI;gBACF,oEAAoE;gBACpE,MAAM,MAAM;YACd,EAAE,OAAO,GAAG;gBACV,iDAAiD;gBACjD,MAAM,QAAQ;gBACd,MAAM,UAAU,MAAM,KAAK,IAAI,MAAM,OAAO;gBAC5C,QAAQ,KAAK,CAAC,CAAC,qBAAqB,EAAE,OAAO,KAAK,EAAE,EAAE,SAAS;YACjE;QACF;QACA,QAAQ,KAAK,CAAC;YAAE;QAAK,GAAG,CAAC,eAAe,EAAE,OAAO,MAAM;QACvD,OAAO,IAAI;IACb;AACF"}},
    {"offset": {"line": 853, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/lib/conversational-ai-api/utils/sub-render.ts"],"sourcesContent":["import type { RTMEvents } from 'agora-rtm-sdk'\nimport _ from 'lodash'\n\nimport {\n  type EAgentState,\n  EChatMessageType,\n  type EConversationalAIAPIEvents,\n  EMessageType,\n  EModuleType,\n  ETranscriptHelperMode,\n  ETurnStatus,\n  type IAgentTranscription,\n  type IConversationalAIAPIEventHandlers,\n  type IMessageError,\n  type IMessageInterrupt,\n  type IMessageMetrics,\n  type IMessageSalStatus,\n  type IPresenceState,\n  type ITranscriptHelperItem,\n  type ITranscriptionBase,\n  type IUserTranscription,\n  type TDataChunkMessageWord,\n  type TQueueItem,\n  type TTranscriptHelperObjectWord\n} from '../type'\nimport { factoryFormatLog } from './index'\nimport { ELoggerType } from './index'\n\n// Simple logger replacement\nconst logger = {\n  debug: (...args: any[]) => console.debug(...args),\n  info: (...args: any[]) => console.info(...args),\n  warn: (...args: any[]) => console.warn(...args),\n  error: (...args: any[]) => console.error(...args),\n}\n\nconst TAG = 'CovSubRenderController'\nconst CONSOLE_LOG_PREFIX = `[${TAG}]`\nconst SELF_USER_ID = 0\nconst VERSION = '1.8.0'\n\nconst DEFAULT_INTERVAL = 200 // milliseconds\nconst DEFAULT_CHUNK_INTERVAL = 100 // milliseconds, 10 char/s\n\nconst formatLog = factoryFormatLog({ tag: TAG })\n\n/**\n * CovSubRenderController is a service that manages the transcript messages from RTM messages.\n *\n * Best practices:\n *\n * 1. Bind `onChatHistoryUpdated` and `onAgentStateChanged` callbacks to handle chat history updates and agent state changes when initializing the service.\n *\n * 2. Call `run` method to start the service. One common use case is to call it after the user joins a channel.\n *\n * 3. Call `setPts` method to update the current PTS (Presentation Time Stamp) when receiving new media data. This is crucial for synchronizing the transcripts with the media playback.\n *\n * 4. [Cleanup] Call `cleanup` method to reset the service state when leaving a channel or when the service is no longer needed. This will clear the chat history, queue, and other internal states.\n */\nexport class CovSubRenderController {\n  private static NAME = TAG\n  private static VERSION = VERSION\n  private callMessagePrint: (type: ELoggerType, ...args: unknown[]) => void\n  public static self_uid = SELF_USER_ID\n\n  private _mode: ETranscriptHelperMode = ETranscriptHelperMode.UNKNOWN\n  private _queue: TQueueItem[] = []\n  private _interval: number\n  private _intervalRef: NodeJS.Timeout | null = null\n  private _pts: number = 0 // current pts\n  private _lastPoppedQueueItem: TQueueItem | null | undefined = null\n  private _isRunning: boolean = false\n  private _agentMessageState: {\n    state: EAgentState\n    turn_id: string | number\n    timestamp: number\n  } | null = null\n  private _transcriptChunk: {\n    index: number\n    data: IAgentTranscription\n    uid: string\n  } | null = null\n\n  public chatHistory: ITranscriptHelperItem<\n    Partial<IUserTranscription | IAgentTranscription>\n  >[] = []\n  public onChatHistoryUpdated:\n    | IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.TRANSCRIPT_UPDATED]\n    | null = null\n  public onAgentStateChanged:\n    | IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.AGENT_STATE_CHANGED]\n    | null\n  public onAgentInterrupted:\n    | IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.AGENT_INTERRUPTED]\n    | null = null\n  public onDebugLog:\n    | IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.DEBUG_LOG]\n    | null = null\n  public onAgentMetrics:\n    | IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.AGENT_METRICS]\n    | null = null\n  public onAgentError:\n    | IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.AGENT_ERROR]\n    | null = null\n  public onMessageReceipt:\n    | IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.MESSAGE_RECEIPT_UPDATED]\n    | null = null\n  public onMessageError:\n    | IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.MESSAGE_ERROR]\n    | null = null\n  public onMessageSalStatus:\n    | IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.MESSAGE_SAL_STATUS]\n    | null = null\n\n  constructor(\n    options: {\n      messageCacheTimeout?: number\n      interval?: number\n      onChatHistoryUpdated?: IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.TRANSCRIPT_UPDATED]\n      onAgentStateChanged?: IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.AGENT_STATE_CHANGED]\n      onAgentInterrupted?: IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.AGENT_INTERRUPTED]\n      onDebugLog?: IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.DEBUG_LOG]\n      onAgentMetrics?: IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.AGENT_METRICS]\n      onAgentError?: IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.AGENT_ERROR]\n      onMessageReceipt?: IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.MESSAGE_RECEIPT_UPDATED]\n      onMessageError?: IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.MESSAGE_ERROR]\n      onMessageSalStatus?: IConversationalAIAPIEventHandlers[EConversationalAIAPIEvents.MESSAGE_SAL_STATUS]\n    } = {}\n  ) {\n    this.callMessagePrint = (\n      type: ELoggerType = ELoggerType.debug,\n      ...args: unknown[]\n    ) => {\n      logger[type](formatLog(...args))\n      this.onDebugLog?.(`[${type}] ${formatLog(...args)}`)\n    }\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `${CovSubRenderController.NAME} initialized, version: ${CovSubRenderController.VERSION}`\n    )\n    this._interval = options.interval ?? DEFAULT_INTERVAL\n    this.onChatHistoryUpdated = options.onChatHistoryUpdated ?? null\n    this.onAgentStateChanged = options.onAgentStateChanged ?? null\n    this.onAgentInterrupted = options.onAgentInterrupted ?? null\n    this.onDebugLog = options.onDebugLog ?? null\n    this.onAgentMetrics = options.onAgentMetrics ?? null\n    this.onAgentError = options.onAgentError ?? null\n    this.onMessageReceipt = options.onMessageReceipt ?? null\n    this.onMessageError = options.onMessageError ?? null\n    this.onMessageSalStatus = options.onMessageSalStatus ?? null\n  }\n\n  private _preSetupInterval() {\n    if (!this._isRunning) {\n      console.error(CONSOLE_LOG_PREFIX, 'Message service is not running')\n      this.callMessagePrint(\n        ELoggerType.error,\n        '_preSetupInterval',\n        'Message service is not running'\n      )\n      return\n    }\n  }\n\n  private _setupIntervalForWords(options?: { isForce?: boolean }) {\n    this._preSetupInterval()\n    // if force: clean older and reset interval\n    if (options?.isForce) {\n      if (this._intervalRef) {\n        clearInterval(this._intervalRef)\n        this._intervalRef = null\n      }\n      this._intervalRef = setInterval(\n        this._handleQueue.bind(this),\n        this._interval\n      )\n      return\n    }\n    // else(if not forced): skip if interval is already set, otherwise set an interval\n    if (this._intervalRef) {\n      return\n    }\n    this._intervalRef = setInterval(\n      this._handleQueue.bind(this),\n      this._interval\n    )\n  }\n\n  private _handleQueue() {\n    const queueLength = this._queue.length\n    // empty queue, skip\n    if (queueLength === 0) {\n      // console.debug(CONSOLE_LOG_PREFIX, 'Queue is empty, skip')\n      return\n    }\n    const curPTS = this._pts\n    // only one item, update chatHistory with queueItem\n    if (queueLength === 1) {\n      // console.debug(\n      //   CONSOLE_LOG_PREFIX,\n      //   'Queue has only one item, update chatHistory',\n      //   JSON.stringify(this._queue[0])\n      // )\n      const queueItem = this._queue[0]\n      this._handleTurnObj(queueItem, curPTS)\n      this._mutateChatHistory()\n      return\n    }\n    if (queueLength > 2) {\n      // console.error(\n      //   CONSOLE_LOG_PREFIX,\n      //   'Queue length is greater than 2, but it should not happen'\n      // )\n      this.callMessagePrint(\n        ELoggerType.error,\n        'Queue length is greater than 2, but it should not happen'\n      )\n    }\n    // assume the queueLength is 2\n    if (queueLength > 1) {\n      this._queue = this._queue.sort((a, b) => a.turn_id - b.turn_id)\n      const nextItem = this._queue[this._queue.length - 1]\n      const lastItem = this._queue[this._queue.length - 2]\n      // check if nextItem is started\n      const firstWordOfNextItem = nextItem.words[0]\n      // if firstWordOfNextItem.start_ms > curPTS, work on lastItem\n      if (firstWordOfNextItem.start_ms > curPTS) {\n        this._handleTurnObj(lastItem, curPTS)\n        this._mutateChatHistory()\n        return\n      }\n      // if firstWordOfNextItem.start_ms <= curPTS, work on nextItem, assume lastItem is interrupted(and drop it)\n      const lastItemCorrespondingChatHistoryItem = this.chatHistory.find(\n        (item) =>\n          item.turn_id === lastItem.turn_id &&\n          item.stream_id === lastItem.stream_id\n      )\n      if (!lastItemCorrespondingChatHistoryItem) {\n        this.callMessagePrint(\n          ELoggerType.warn,\n          'No corresponding chatHistory item found',\n          lastItem\n        )\n        return\n      }\n      lastItemCorrespondingChatHistoryItem.status = ETurnStatus.INTERRUPTED\n      this._lastPoppedQueueItem = this._queue.shift()\n      // handle nextItem\n      this._handleTurnObj(nextItem, curPTS)\n      this._mutateChatHistory()\n      return\n    }\n  }\n\n  private _handleTurnObj(queueItem: TQueueItem, curPTS: number) {\n    let correspondingChatHistoryItem = this.chatHistory.find(\n      (item) =>\n        item.turn_id === queueItem.turn_id &&\n        item.stream_id === queueItem.stream_id\n    )\n    this.callMessagePrint(\n      ELoggerType.debug,\n      'handleTurnObj',\n      queueItem,\n      'correspondingChatHistoryItem',\n      correspondingChatHistoryItem\n    )\n    if (!correspondingChatHistoryItem) {\n      this.callMessagePrint(\n        ELoggerType.debug,\n        'handleTurnObj',\n        'No corresponding chatHistory item found',\n        'push to chatHistory'\n      )\n      correspondingChatHistoryItem = {\n        turn_id: queueItem.turn_id,\n        uid: queueItem.uid,\n        stream_id: queueItem.stream_id,\n        _time: new Date().getTime(),\n        text: '',\n        status: queueItem.status,\n        metadata: queueItem\n      }\n      this._appendChatHistory(correspondingChatHistoryItem)\n    }\n    // update correspondingChatHistoryItem._time for chatHistory auto-scroll\n    correspondingChatHistoryItem._time = new Date().getTime()\n    // update correspondingChatHistoryItem.metadata\n    correspondingChatHistoryItem.metadata = queueItem\n    // update correspondingChatHistoryItem.status if queueItem.status is interrupted(from message.interrupt event)\n    if (queueItem.status === ETurnStatus.INTERRUPTED) {\n      correspondingChatHistoryItem.status = ETurnStatus.INTERRUPTED\n    }\n    // pop all valid word items(those word.start_ms <= curPTS) in queueItem\n    const validWords: TTranscriptHelperObjectWord[] = []\n    const restWords: TTranscriptHelperObjectWord[] = []\n    for (const word of queueItem.words) {\n      if (word.start_ms <= curPTS) {\n        validWords.push(word)\n      } else {\n        restWords.push(word)\n      }\n    }\n    // check if restWords is empty\n    const isRestWordsEmpty = restWords.length === 0\n    // check if validWords last word is final\n    const isLastWordFinal =\n      validWords[validWords.length - 1]?.word_status !== ETurnStatus.IN_PROGRESS\n    // if restWords is empty and validWords last word is final, this turn is ended\n    if (isRestWordsEmpty && isLastWordFinal) {\n      // update chatHistory with queueItem\n      correspondingChatHistoryItem.text = queueItem.text\n      correspondingChatHistoryItem.status = queueItem.status\n      // pop queueItem\n      this._lastPoppedQueueItem = this._queue.shift()\n      return\n    }\n    // if restWords is not empty, update correspondingChatHistoryItem.text\n    const validWordsText = validWords\n      .filter((word) => word.start_ms <= this._pts)\n      .map((word) => word.word)\n      .join('')\n    correspondingChatHistoryItem.text = validWordsText\n    // if validWords last word is interrupted, this turn is ended\n    const isLastWordInterrupted =\n      validWords[validWords.length - 1]?.word_status === ETurnStatus.INTERRUPTED\n    if (isLastWordInterrupted) {\n      // pop queueItem\n      this._lastPoppedQueueItem = this._queue.shift()\n      return\n    }\n    return\n  }\n\n  private _mutateChatHistory() {\n    // console.debug(CONSOLE_LOG_PREFIX, 'Mutate chatHistory', this.chatHistory)\n    this.callMessagePrint(\n      ELoggerType.debug,\n      '>>> onChatHistoryUpdated',\n      `pts: ${this._pts}, chatHistory length: ${this.chatHistory.length}`,\n      this.chatHistory\n        .map((item) => `${item.uid}:${item.text}[status: ${item.status}]`)\n        .join('\\n')\n    )\n    this.onChatHistoryUpdated?.(this.chatHistory)\n  }\n\n  private _appendChatHistory(\n    item: ITranscriptHelperItem<\n      Partial<IUserTranscription | IAgentTranscription>\n    >\n  ) {\n    // if item.turn_id is 0, append to the front of chatHistory(greeting message)\n    if (item.turn_id === 0) {\n      this.chatHistory = [item, ...this.chatHistory]\n    } else {\n      this.chatHistory.push(item)\n    }\n  }\n\n  private _interruptQueue(options: { turn_id: number; start_ms: number }) {\n    const turn_id = options.turn_id\n    const start_ms = options.start_ms\n    const correspondingQueueItem = this._queue.find(\n      (item) => item.turn_id === turn_id\n    )\n    this.callMessagePrint(\n      ELoggerType.debug,\n      'interruptQueue',\n      `turn_id: ${turn_id}, start_ms: ${start_ms}, correspondingQueueItem: ${correspondingQueueItem}`\n    )\n    if (!correspondingQueueItem) {\n      // console.debug(\n      //   CONSOLE_LOG_PREFIX,\n      //   'No corresponding queue item found',\n      //   options\n      // )\n      return\n    }\n    // if correspondingQueueItem exists, update its status to interrupted\n    correspondingQueueItem.status = ETurnStatus.INTERRUPTED\n    // split words into two parts, set left one word and all right words to interrupted\n    const leftWords = correspondingQueueItem.words.filter(\n      (word) => word.start_ms <= start_ms\n    )\n    const rightWords = correspondingQueueItem.words.filter(\n      (word) => word.start_ms > start_ms\n    )\n    // check if leftWords is empty\n    const isLeftWordsEmpty = leftWords.length === 0\n    if (isLeftWordsEmpty) {\n      // if leftWords is empty, set all words to interrupted\n      correspondingQueueItem.words.forEach((word) => {\n        word.word_status = ETurnStatus.INTERRUPTED\n      })\n    } else {\n      // if leftWords is not empty, set leftWords[leftWords.length - 1].word_status to interrupted\n      leftWords[leftWords.length - 1].word_status = ETurnStatus.INTERRUPTED\n      // workaround: pts < interrupt.start_ms, and interrupt will be ignored\n      if (leftWords?.[leftWords.length - 2]) {\n        leftWords[leftWords.length - 2].word_status = ETurnStatus.INTERRUPTED\n      }\n      // and all right words to interrupted\n      rightWords.forEach((word) => {\n        word.word_status = ETurnStatus.INTERRUPTED\n      })\n      // update words\n      correspondingQueueItem.words = [...leftWords, ...rightWords]\n    }\n  }\n\n  private _pushToQueue(data: {\n    turn_id: number\n    words: TTranscriptHelperObjectWord[]\n    text: string\n    status: ETurnStatus\n    stream_id: number\n    uid: string\n  }) {\n    const targetQueueItem = this._queue.find(\n      (item) => item.turn_id === data.turn_id\n    )\n    const latestTurnId = this._queue.reduce((max, item) => {\n      return Math.max(max, item.turn_id)\n    }, 0)\n    // if not found, push to queue or drop if turn_id is less than latestTurnId\n    if (!targetQueueItem) {\n      // drop if turn_id is less than latestTurnId\n      if (data.turn_id < latestTurnId) {\n        this.callMessagePrint(\n          ELoggerType.debug,\n          `[Word Mode]`,\n          `[${data.uid}]`,\n          'Drop message with turn_id less than latestTurnId',\n          `turn_id: ${data.turn_id}, latest turn_id: ${latestTurnId}`,\n          data\n        )\n        return\n      }\n      const newQueueItem = {\n        turn_id: data.turn_id,\n        text: data.text,\n        words: this.sortWordsWithStatus(data.words, data.status),\n        status: data.status,\n        stream_id: data.stream_id,\n        uid: data.uid\n      }\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `[Word Mode]`,\n        `[${data.uid}]`,\n        'push to queue',\n        newQueueItem\n      )\n      // push to queue\n      this._queue.push(newQueueItem)\n      return\n    }\n    // if found, update text, words(sorted with status) and turn_status\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `[Word Mode]`,\n      `[${data.uid}]`,\n      'update queue item',\n      targetQueueItem,\n      data\n    )\n    targetQueueItem.text = data.text\n    targetQueueItem.words = this.sortWordsWithStatus(\n      [...targetQueueItem.words, ...data.words],\n      data.status\n    )\n    // if targetQueueItem.status is end, and data.status is in_progress, skip status update (unexpected case)\n    if (\n      targetQueueItem.status !== ETurnStatus.IN_PROGRESS &&\n      data.status === ETurnStatus.IN_PROGRESS\n    ) {\n      return\n    }\n    targetQueueItem.status = data.status\n  }\n\n  private _teardownInterval() {\n    if (this._intervalRef) {\n      clearInterval(this._intervalRef)\n      this._intervalRef = null\n    }\n  }\n\n  protected sortWordsWithStatus(\n    words: TDataChunkMessageWord[],\n    turn_status: ETurnStatus\n  ) {\n    if (words.length === 0) {\n      return words\n    }\n    const sortedWords: TTranscriptHelperObjectWord[] = words\n      .map((word) => ({\n        ...word,\n        word_status: ETurnStatus.IN_PROGRESS\n      }))\n      .sort((a, b) => a.start_ms - b.start_ms)\n      .reduce((acc, curr) => {\n        // Only add if start_ms is unique\n        if (!acc.find((word) => word.start_ms === curr.start_ms)) {\n          acc.push(curr)\n        }\n        return acc\n      }, [] as TTranscriptHelperObjectWord[])\n    const isMessageFinal = turn_status !== ETurnStatus.IN_PROGRESS\n    if (isMessageFinal) {\n      sortedWords[sortedWords.length - 1].word_status = turn_status\n    }\n    return sortedWords\n  }\n\n  protected handleTextMessage(uid: string, message: IUserTranscription | IAgentTranscription) {\n    const turn_id = message.turn_id\n    const text = message.text || ''\n    const stream_id = message.stream_id\n    const turn_status = ETurnStatus.END\n\n    // Determine if this is an agent message by checking the message object type\n    const isAgentMessage = message.object === EMessageType.AGENT_TRANSCRIPTION;\n    \n    // For agent messages, use \"1000\" as the UID (agent's fixed UID)\n    // For user messages, use the publisher UID\n    const finalUid = isAgentMessage ? \"1000\" : `${uid}`;\n\n\n    const targetChatHistoryItem = this.chatHistory.find(\n      (item) => item.turn_id === turn_id && item.stream_id === stream_id\n    )\n    // if not found, push to chatHistory\n    if (!targetChatHistoryItem) {\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `[Text Mode]`,\n        `[${finalUid}]`,\n        'new item',\n        message\n      )\n      // For agent messages, show intermediate messages too (for real-time updates)\n      // For user messages, only show final to avoid duplicates\n      if (isAgentMessage) {\n        // Always add agent messages (both intermediate and final) for real-time updates\n        this._appendChatHistory({\n          turn_id,\n          uid: finalUid,\n          stream_id,\n          _time: new Date().getTime(),\n          text,\n          status: turn_status,\n          metadata: message\n        })\n        this._mutateChatHistory()\n      } else {\n        // For user messages, only add final messages\n        const isFinal = (message as any).final === true || \n                       (message as any).is_final === true ||\n                       (message as any).turn_status === 1 ||\n                       turn_status === ETurnStatus.END;\n        \n        if (isFinal) {\n          this._appendChatHistory({\n            turn_id,\n            uid: finalUid,\n            stream_id,\n            _time: new Date().getTime(),\n            text,\n            status: ETurnStatus.END,\n            metadata: message\n          })\n          this._mutateChatHistory()\n        } else {\n          return; // Don't add non-final user messages to chat history\n        }\n      }\n    } else {\n      // if found, update it (for agent messages, update even if not final for real-time)\n      // For user messages, only update if final\n      const isFinal = (message as any).final === true || \n                     (message as any).is_final === true ||\n                     (message as any).turn_status === 1 ||\n                     turn_status === ETurnStatus.END;\n      \n      if (isAgentMessage || isFinal) {\n        // Always update agent messages (for real-time), or final user messages\n        targetChatHistoryItem.text = text\n        targetChatHistoryItem.status = isFinal ? ETurnStatus.END : turn_status\n        targetChatHistoryItem.metadata = message\n        targetChatHistoryItem._time = new Date().getTime()\n        // Update UID if it changed (e.g., if we misidentified it before)\n        if (targetChatHistoryItem.uid !== finalUid) {\n          targetChatHistoryItem.uid = finalUid;\n        }\n        this.callMessagePrint(\n          ELoggerType.debug,\n          `[Text Mode]`,\n          `[${finalUid}]`,\n          targetChatHistoryItem\n        )\n        this._mutateChatHistory()\n      } else {\n      }\n    }\n  }\n\n  private _handleTranscriptChunk() {\n    if (!this._transcriptChunk) {\n      this.callMessagePrint(\n        ELoggerType.warn,\n        `[${ETranscriptHelperMode.CHUNK} Mode]`,\n        '_handleTranscriptChunk',\n        'missing _transcriptChunk'\n      )\n      return\n    }\n    const currentIdx = this._transcriptChunk.index\n    const currentTranscript = this._transcriptChunk.data\n    const currentMaxLength = currentTranscript.text.length\n    const uid = this._transcriptChunk.uid\n\n    const nextIdx =\n      currentIdx + 1 >= currentMaxLength ? currentMaxLength : currentIdx + 1\n    this._transcriptChunk.index = nextIdx\n    const validTranscriptString = currentTranscript.text.substring(0, nextIdx)\n    const isValidTranscriptStringEnded =\n      validTranscriptString.length > 0 &&\n      currentTranscript.turn_status !== ETurnStatus.IN_PROGRESS &&\n      validTranscriptString.length === currentTranscript.text.length\n\n    const targetChatHistoryItem = this.chatHistory.find(\n      (item) =>\n        item.turn_id === currentTranscript.turn_id &&\n        item.stream_id === currentTranscript.stream_id\n    )\n    // if not found, push to chatHistory\n    if (!targetChatHistoryItem) {\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `[${ETranscriptHelperMode.CHUNK} Mode]`,\n        `[${uid}]`,\n        'new transcriptChunk',\n        this._transcriptChunk\n      )\n      this._appendChatHistory({\n        turn_id: currentTranscript.turn_id,\n        uid: currentTranscript.stream_id\n          ? `${CovSubRenderController.self_uid}`\n          : `${uid}`,\n        stream_id: currentTranscript.stream_id,\n        _time: Date.now(),\n        text: validTranscriptString,\n        status: currentTranscript.turn_status,\n        metadata: currentTranscript\n      })\n    } else {\n      // if found, update text and status\n      targetChatHistoryItem.text = validTranscriptString\n      targetChatHistoryItem.status = isValidTranscriptStringEnded\n        ? currentTranscript.turn_status\n        : targetChatHistoryItem.status\n      targetChatHistoryItem.metadata = currentTranscript\n      targetChatHistoryItem._time = Date.now()\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `[${ETranscriptHelperMode.CHUNK} Mode]`,\n        `[${uid}]`,\n        'update transcriptChunk',\n        targetChatHistoryItem\n      )\n    }\n    this._mutateChatHistory()\n  }\n\n  protected handleChunkTextMessage(uid: string, message: IAgentTranscription) {\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `[${ETranscriptHelperMode.CHUNK} Mode]`,\n      `[${uid}]`,\n      'new item',\n      message\n    )\n    // 0. check turn_id, teardown interval if new turn\n    if (\n      this._transcriptChunk &&\n      this._transcriptChunk.data.turn_id < message.turn_id\n    ) {\n      this._teardownInterval()\n      // set chathistory items turn_status to ended\n      const lastChatHistory = this.chatHistory.find(\n        (item) =>\n          item.turn_id === this._transcriptChunk?.data.turn_id &&\n          item.uid === uid\n      )\n      if (lastChatHistory) {\n        lastChatHistory.status = ETurnStatus.END\n      }\n      // set _transcriptChunk to null\n      this._transcriptChunk = null\n    }\n    // 1. update _transcriptChunk\n    this._transcriptChunk = {\n      index: this._transcriptChunk?.index ?? 0,\n      data: message,\n      uid\n    }\n    // 2. check if interval is set, if not, set it\n    if (!this._intervalRef) {\n      this._intervalRef = setInterval(\n        this._handleTranscriptChunk.bind(this),\n        this._interval\n      )\n    }\n  }\n\n  protected handleMessageInterrupt(uid: string, message: IMessageInterrupt) {\n    this.callMessagePrint(\n      ELoggerType.debug,\n      '<<< [onInterrupted]',\n      `pts: ${this._pts}, uid: ${uid}`,\n      message\n    )\n    const turn_id = message.turn_id\n    // workaround: pts < interrupt.start_ms, and interrupt will be ignored\n    const start_ms = _.min([message.start_ms, this._pts]) || message.start_ms\n    this._interruptQueue({\n      turn_id,\n      start_ms\n    })\n    // interrupt chunk\n    if (this._transcriptChunk) {\n      this._teardownInterval()\n      // set chathistory items turn_status to ended\n      const lastChatHistory = this.chatHistory.find(\n        (item) =>\n          item.turn_id === this._transcriptChunk?.data.turn_id &&\n          item.uid === uid\n      )\n      if (lastChatHistory) {\n        lastChatHistory.status = ETurnStatus.INTERRUPTED\n      }\n      // set _transcriptChunk to null\n      this._transcriptChunk = null\n    }\n    this._mutateChatHistory()\n    this.onAgentInterrupted?.(`${uid}`, {\n      turnID: turn_id,\n      timestamp: start_ms\n    })\n  }\n\n  protected handleMessageMetrics(uid: string, message: IMessageMetrics) {\n    // this.callMessagePrint(\n    //   ELoggerType.debug,\n    //   '<<< [onMetrics]',\n    //   `pts: ${this._pts}, uid: ${uid}`,\n    //   message\n    // )\n    const latency_ms = message.latency_ms\n    const messageModule = message.module\n    const metric_name = message.metric_name\n\n    if (!Object.values(EModuleType).includes(messageModule)) {\n      this.callMessagePrint(ELoggerType.warn, 'Unknown metric module:', message)\n      return\n    }\n\n    this.onAgentMetrics?.(`${uid}`, {\n      type: messageModule,\n      name: metric_name,\n      value: latency_ms,\n      timestamp: message.send_ts\n    })\n  }\n\n  protected handleMessageSalStatus(uid: string, message: IMessageSalStatus) {\n    this.callMessagePrint(ELoggerType.debug, 'handleMessageSalStatus', message)\n    this.onMessageSalStatus?.(`${uid}`, message)\n  }\n\n  protected handleMessageError(uid: string, message: IMessageError) {\n    // this.callMessagePrint(\n    //   ELoggerType.debug,\n    //   '<<< [onError]',\n    //   `pts: ${this._pts}, uid: ${uid}`,\n    //   message\n    // )\n    const errorCode = message.code || -1\n    const errorMessage = message.message\n    const messageModule = message.module\n\n    if (!Object.values(EModuleType).includes(messageModule)) {\n      this.callMessagePrint(ELoggerType.warn, 'Unknown error module:', message)\n      return\n    }\n\n    if (messageModule === EModuleType.CONTEXT) {\n      try {\n        const messageData = JSON.parse(errorMessage)\n        const errorPayload = {\n          type:\n            messageData?.module === 'picture'\n              ? EChatMessageType.IMAGE\n              : EChatMessageType.UNKNOWN,\n          code: errorCode,\n          message: errorMessage,\n          timestamp: (message?.send_ts as number) || Date.now()\n        }\n        this.onMessageError?.(`${uid}`, errorPayload)\n      } catch (error: unknown) {\n        this.callMessagePrint(\n          ELoggerType.error,\n          'Failed to parse context error message',\n          error,\n          message\n        )\n      }\n    }\n\n    this.onAgentError?.(`${uid}`, {\n      type: messageModule,\n      code: errorCode,\n      message: errorMessage,\n      timestamp: (message?.send_ts as number) || Date.now()\n    })\n  }\n\n  // current only used for image messages\n  protected handleMessageInfo(uid: string, message: Record<string, unknown>) {\n    try {\n      const messageStr = (message?.message as string) || ''\n      const messageObj = JSON.parse(messageStr)\n      const moduleType = message?.module as EModuleType\n      const turnId = message?.turn_id as number\n      if (!messageStr || !messageObj || !moduleType || !turnId) {\n        this.callMessagePrint(\n          ELoggerType.error,\n          'handleMessageInfo',\n          'Invalid message object',\n          message\n        )\n        return\n      }\n      const messageType =\n        message?.resource_type === 'picture'\n          ? EChatMessageType.IMAGE\n          : EChatMessageType.UNKNOWN\n      this.onMessageReceipt?.(uid, {\n        moduleType,\n        messageType,\n        message: messageStr,\n        turnId\n      })\n    } catch (error: unknown) {\n      this.callMessagePrint(\n        ELoggerType.debug,\n        'handleMessageInfo',\n        'Failed to parse message string from image info message',\n        error,\n        message\n      )\n    }\n  }\n\n  public handleAgentStatus(metadata: IPresenceState) {\n    // this.callMessagePrint(\n    //   ELoggerType.debug,\n    //   'handleAgentStatus',\n    //   `pts: ${this._pts}, uid: ${metadata.publisher}`,\n    //   `prev-state: ${this._agentMessageState}, state: ${metadata.stateChanged.state}, turn_id: ${metadata.stateChanged.turn_id}, timestamp: ${metadata.stateChanged.timestamp}`\n    // )\n    const message = metadata.stateChanged\n    const currentTurnId = _.toNumber(message.turn_id) || 0\n    if (_.toNumber(this._agentMessageState?.turn_id || 0) > currentTurnId) {\n      this.callMessagePrint(\n        ELoggerType.debug,\n        'handleAgentStatus',\n        'ignore older message(turn_id)'\n      )\n      return\n    }\n    // check if message is older(by timestamp) than previous one, if so, skip\n    const currentMsgTs = metadata.timestamp\n    if (_.toNumber(this._agentMessageState?.timestamp || 0) >= currentMsgTs) {\n      // console.debug(\n      //   CONSOLE_LOG_PREFIX,\n      //   'handleAgentStatus',\n      //   'ignore older message(timestamp)',\n      //   message?.timestamp,\n      //   currentMsgTs\n      // )\n      this.callMessagePrint(\n        ELoggerType.debug,\n        'handleAgentStatus',\n        'ignore older message(timestamp)'\n      )\n      return\n    }\n    this.callMessagePrint(\n      ELoggerType.debug,\n      '>>> handleAgentStatus',\n      `pts: ${this._pts}, uid: ${metadata.publisher}`,\n      `prev-state: ${this._agentMessageState?.state}, prev-turn_id: ${this._agentMessageState?.turn_id}, prev-timestamp: ${this._agentMessageState?.timestamp}`,\n      `current-state: ${metadata.stateChanged.state}, turn_id: ${metadata.stateChanged.turn_id}, timestamp: ${metadata.timestamp}`\n    )\n    // set current message state\n    this._agentMessageState = {\n      state: message.state,\n      turn_id: message.turn_id,\n      timestamp: currentMsgTs\n    }\n    this.onAgentStateChanged?.(metadata.publisher, {\n      state: message.state,\n      turnID: _.toNumber(message.turn_id),\n      timestamp: currentMsgTs,\n      reason: ''\n    })\n  }\n\n  protected handleWordAgentMessage(uid: string, message: IAgentTranscription) {\n    // drop message if turn_status is undefined\n    if (typeof message.turn_status === 'undefined') {\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `[Word Mode]`,\n        `[${uid}]`,\n        'Drop message with undefined turn_status',\n        message.turn_id\n      )\n      return\n    }\n\n    const turn_id = message.turn_id\n    const text = message.text || ''\n    const words = message.words || []\n    const stream_id = message.stream_id\n    const lastPoppedQueueItemTurnId = this._lastPoppedQueueItem?.turn_id\n    // drop message if turn_id is less than last popped queue item\n    // except for the first turn(greeting message, turn_id is 0)\n    if (\n      lastPoppedQueueItemTurnId &&\n      turn_id !== 0 &&\n      turn_id <= lastPoppedQueueItemTurnId\n    ) {\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `[Word Mode]`,\n        `[${uid}]`,\n        'Drop message with turn_id less than last popped queue item',\n        `turn_id: ${turn_id}, last popped queue item turn_id: ${lastPoppedQueueItemTurnId}`\n      )\n      return\n    }\n    this._pushToQueue({\n      uid: message.stream_id ? `${CovSubRenderController.self_uid}` : `${uid}`,\n      turn_id,\n      words,\n      text,\n      status: message.turn_status,\n      stream_id\n    })\n  }\n\n  public setMode(mode: ETranscriptHelperMode) {\n    if (this._mode !== ETranscriptHelperMode.UNKNOWN) {\n      this.callMessagePrint(\n        ELoggerType.warn,\n        `Mode should only be set once, but it is set[${mode}] again`,\n        'current mode:',\n        this._mode\n      )\n      return\n    }\n    if (mode === ETranscriptHelperMode.UNKNOWN) {\n      this.callMessagePrint(ELoggerType.warn, 'Unknown mode should not be set')\n      return\n    }\n    if (mode === ETranscriptHelperMode.CHUNK) {\n      // set interval to chunk interval\n      this._interval = DEFAULT_CHUNK_INTERVAL\n    } else {\n      // set interval to default interval\n      this._interval = DEFAULT_INTERVAL\n    }\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `setMode`,\n      ETranscriptHelperMode.TEXT\n    )\n    this._mode = mode\n  }\n\n  public handleMessage<T extends ITranscriptionBase>(\n    message: T,\n    options: {\n      publisher: RTMEvents.MessageEvent['publisher']\n    }\n  ) {\n    const messageObject = message?.object\n    if (!Object.values(EMessageType).includes(messageObject)) {\n      console.warn(\"[CovSubRenderController] Unknown message type:\", messageObject, message);\n      // Don't return early - try to handle it anyway if it has text\n      if (!message.text && !(message as any).content) {\n        this.callMessagePrint(\n          ELoggerType.info,\n          `<<< [unknown message]`,\n          options,\n          message\n        )\n        return\n      }\n      // If it has text but unknown object type, treat it as a transcription\n    }\n\n    const isAgentMessage = message.object === EMessageType.AGENT_TRANSCRIPTION\n    const isUserMessage = message.object === EMessageType.USER_TRANSCRIPTION\n    const isMessageInterrupt = message.object === EMessageType.MSG_INTERRUPTED\n    const isMessageMetrics = message.object === EMessageType.MSG_METRICS\n    const isMessageError = message.object === EMessageType.MSG_ERROR\n    // const isMessageState = message.object === EMessageType.MSG_STATE\n    const isMessageInfo = message.object === EMessageType.MESSAGE_INFO\n    const isMessageSalStatus =\n      message.object === EMessageType.MESSAGE_SAL_STATUS\n\n    // set mode (only once)\n    if (isAgentMessage && this._mode === ETranscriptHelperMode.UNKNOWN) {\n      // 2025-09-28 check if words array is empty or not undefined, and set mode\n      if (\n        !message.words ||\n        (Array.isArray(message.words) && message.words.length === 0)\n      ) {\n        this.setMode(ETranscriptHelperMode.TEXT)\n      } else {\n        this._setupIntervalForWords({ isForce: true })\n        this.setMode(ETranscriptHelperMode.WORD)\n      }\n    }\n\n    // handle Agent Message\n    if (isAgentMessage && this._mode === ETranscriptHelperMode.WORD) {\n      this._setupIntervalForWords({ isForce: false })\n      this.handleWordAgentMessage(\n        options.publisher,\n        message as unknown as IAgentTranscription\n      )\n      return\n    }\n    if (isAgentMessage && this._mode === ETranscriptHelperMode.TEXT) {\n      console.log(\"[CovSubRenderController] Handling agent text message:\", {\n        publisher: options.publisher,\n        message,\n        messageObject: message.object,\n      });\n      // Pass the message as-is, handleTextMessage will determine UID based on message.object\n      this.handleTextMessage(\n        options.publisher, // Publisher UID (will be overridden to \"1000\" for agent messages)\n        message as unknown as IAgentTranscription\n      )\n      return\n    }\n    if (isAgentMessage && this._mode === ETranscriptHelperMode.CHUNK) {\n      this.handleChunkTextMessage(\n        options.publisher,\n        message as unknown as IAgentTranscription\n      )\n      return\n    }\n    // handle User Message\n    if (isUserMessage) {\n      console.log(\"[CovSubRenderController] Handling user text message:\", {\n        publisher: options.publisher,\n        message,\n      });\n      this.handleTextMessage(\n        options.publisher, // Use publisher as UID for user messages\n        message as unknown as IUserTranscription\n      )\n      return\n    }\n    // handle Message Interrupt\n    if (isMessageInterrupt) {\n      this.handleMessageInterrupt(\n        options.publisher,\n        message as unknown as IMessageInterrupt\n      )\n      return\n    }\n    // if (isMessageState) {\n    //   this.handleAgentStatus(message as unknown as IMessageState)\n    //   return\n    // }\n    if (isMessageInfo) {\n      this.handleMessageInfo(\n        options.publisher,\n        message as unknown as Record<string, unknown>\n      )\n      return\n    }\n    if (isMessageMetrics) {\n      this.handleMessageMetrics(\n        options.publisher,\n        message as unknown as IMessageMetrics\n      )\n      return\n    }\n    if (isMessageError) {\n      this.handleMessageError(\n        options.publisher,\n        message as unknown as IMessageError\n      )\n      return\n    }\n\n    if (isMessageSalStatus) {\n      this.handleMessageSalStatus(options.publisher, message as unknown as any)\n      return\n    }\n  }\n\n  public run() {\n    this._isRunning = true\n  }\n\n  public setPts(pts: number) {\n    if (this._pts < pts && pts !== 0) {\n      this._pts = pts\n    }\n  }\n\n  public cleanup() {\n    // console.debug(CONSOLE_LOG_PREFIX, 'Cleanup message service')\n    this.callMessagePrint(ELoggerType.debug, 'cleanup')\n    this._isRunning = false\n    this._teardownInterval()\n    // cleanup queue\n    this._queue = []\n    this._lastPoppedQueueItem = null\n    this._pts = 0\n    // cleanup chatHistory\n    this.chatHistory = []\n    // cleanup mode\n    this._mode = ETranscriptHelperMode.UNKNOWN\n    this._agentMessageState = null\n    this._transcriptChunk = null\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1625, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/lib/conversational-ai-api/index.ts"],"sourcesContent":["import type { IAgoraRTCClient } from \"agora-rtc-sdk-ng\";\nimport type { ChannelType, RTMClient, RTMEvents } from \"agora-rtm-sdk\";\n\nimport {\n  type EAgentState,\n  EChatMessagePriority,\n  EChatMessageType,\n  EConversationalAIAPIEvents,\n  EMessageType,\n  ERTCEvents,\n  ERTMEvents,\n  ETranscriptHelperMode,\n  type IAgentTranscription,\n  type IChatMessageImage,\n  type IChatMessageText,\n  type IConversationalAIAPIEventHandlers,\n  type IMessageSalStatus,\n  type ITranscriptHelperItem,\n  type IUserTranscription,\n  NotFoundError,\n  type TAgentMetric,\n  type TMessageReceipt,\n  type TModuleError,\n  type TStateChangeEvent,\n} from \"./type\";\nimport { factoryFormatLog, ELoggerType } from \"./utils\";\nimport { EventHelper } from \"./utils/event\";\nimport { CovSubRenderController } from \"./utils/sub-render\";\n\n// Simple logger replacement\nconst logger = {\n  debug: (...args: any[]) => console.debug(...args),\n  info: (...args: any[]) => console.info(...args),\n  warn: (...args: any[]) => console.warn(...args),\n  error: (...args: any[]) => console.error(...args),\n};\n\n// Simple ID generator\nconst genTranceID = () => Math.random().toString(36).substring(2, 15);\n\nconst TAG = \"ConversationalAIAPI\";\n// const CONSOLE_LOG_PREFIX = `[${TAG}]`\nconst VERSION = \"1.8.0\";\n\nconst formatLog = factoryFormatLog({ tag: TAG });\n\nexport interface IConversationalAIAPIConfig {\n  rtcEngine: IAgoraRTCClient;\n  rtmEngine: RTMClient;\n  renderMode?: ETranscriptHelperMode;\n  enableLog?: boolean;\n}\n\n/**\n * A class that manages conversational AI interactions through Agora's RTC and RTM services.\n *\n * Provides functionality to handle real-time communication between users and AI agents,\n * including message processing, state management, and event handling. It integrates with\n * Agora's RTC client for audio streaming and RTM client for messaging.\n *\n * Key features\n * - Singleton instance management\n * - RTC and RTM event handling\n * - Chat history and transcription management\n * - Agent state monitoring\n * - Debug logging\n * - Event subscription and management through EventHelper\n *\n * @remarks\n * - Must be initialized with {@link IConversationalAIAPIConfig} before use\n * - Only one instance can exist at a time\n * - Requires both RTC and RTM engines to be properly configured\n * - Events are emitted for state changes, transcriptions, and errors\n * - Extends EventHelper to provide event subscription capabilities\n *\n * @example\n * Basic initialization and usage:\n * ```typescript\n * const api = ConversationalAIAPI.init({\n *   rtcEngine: rtcClient,\n *   rtmEngine: rtmClient,\n *   renderMode: ETranscriptHelperMode.REALTIME\n * });\n *\n * // Subscribe to a channel\n * api.subscribeMessage('channel-id');\n * ```\n *\n * @example\n * Event handling with EventHelper methods:\n * ```typescript\n * const conversationalAIAPI = ConversationalAIAPI.getInstance();\n *\n * // Subscribe to all events using on() method\n * conversationalAIAPI.on(EConversationalAIAPIEvents.AGENT_STATE_CHANGED, (agentUserId, event) => {\n *   console.log(`Agent ${agentUserId} state changed to:`, event.state);\n * });\n *\n * conversationalAIAPI.on(EConversationalAIAPIEvents.TRANSCRIPT_UPDATED, (transcription) => {\n *   console.log('Transcription updated:', transcription);\n * });\n *\n * conversationalAIAPI.on(EConversationalAIAPIEvents.AGENT_INTERRUPTED, (agentUserId, event) => {\n *   console.log(`Agent ${agentUserId} interrupted:`, event);\n * });\n *\n * conversationalAIAPI.on(EConversationalAIAPIEvents.AGENT_METRICS, (agentUserId, metrics) => {\n *   console.log(`Agent ${agentUserId} metrics:`, metrics);\n * });\n *\n * conversationalAIAPI.on(EConversationalAIAPIEvents.AGENT_ERROR, (agentUserId, error) => {\n *   console.error(`Agent ${agentUserId} error:`, error.message);\n * });\n *\n * conversationalAIAPI.on(EConversationalAIAPIEvents.DEBUG_LOG, (message) => {\n *   console.debug('Debug log:', message);\n * });\n *\n * conversationalAIAPI.on(EConversationalAIAPIEvents.MESSAGE_RECEIPT_UPDATED, (agentUserId, messageReceipt) => {\n *  console.log(`Message receipt updated for agent ${agentUserId}:`, messageReceipt);\n * });\n *\n * conversationalAIAPI.on(EConversationalAIAPIEvents.MESSAGE_ERROR, (agentUserId, error) => {\n *  console.error(`Message error for agent ${agentUserId}:`, error);\n * });\n *\n * // Unsubscribe from events using off() method\n * conversationalAIAPI.off(EConversationalAIAPIEvents.AGENT_STATE_CHANGED, handleAgentStateChanged);\n * conversationalAIAPI.off(EConversationalAIAPIEvents.TRANSCRIPT_UPDATED, handleTranscriptionUpdated);\n * conversationalAIAPI.off(EConversationalAIAPIEvents.AGENT_INTERRUPTED, handleAgentInterrupted);\n * conversationalAIAPI.off(EConversationalAIAPIEvents.AGENT_METRICS, handleAgentMetrics);\n * conversationalAIAPI.off(EConversationalAIAPIEvents.AGENT_ERROR, handleAgentError);\n * conversationalAIAPI.off(EConversationalAIAPIEvents.DEBUG_LOG, handleDebugLog);\n * conversationalAIAPI.off(EConversationalAIAPIEvents.MESSAGE_RECEIPT_UPDATED, handleMessageReceiptUpdated);\n * conversationalAIAPI.off(EConversationalAIAPIEvents.MESSAGE_ERROR, handleMessageError);\n * ```\n *\n * @fires {@link EConversationalAIAPIEvents.TRANSCRIPT_UPDATED} When chat history is updated\n * @fires {@link EConversationalAIAPIEvents.AGENT_STATE_CHANGED} When agent state changes\n * @fires {@link EConversationalAIAPIEvents.AGENT_INTERRUPTED} When agent is interrupted\n * @fires {@link EConversationalAIAPIEvents.AGENT_METRICS} When agent metrics are received\n * @fires {@link EConversationalAIAPIEvents.AGENT_ERROR} When an error occurs\n * @fires {@link EConversationalAIAPIEvents.DEBUG_LOG} When debug logs are generated\n * @fires {@link EConversationalAIAPIEvents.MESSAGE_RECEIPT_UPDATED} When message receipt is updated\n * @fires {@link EConversationalAIAPIEvents.MESSAGE_ERROR} When message error occurs\n *\n * @since 1.7.0\n */\nexport class ConversationalAIAPI extends EventHelper<IConversationalAIAPIEventHandlers> {\n  private static NAME = TAG;\n  private static VERSION = VERSION;\n  private static _instance: ConversationalAIAPI | null = null;\n  private callMessagePrint: (type: ELoggerType, ...args: unknown[]) => void;\n\n  protected rtcEngine: IAgoraRTCClient | null = null;\n  protected rtmEngine: RTMClient | null = null;\n  protected renderMode: ETranscriptHelperMode = ETranscriptHelperMode.UNKNOWN;\n  protected channel: string | null = null;\n  protected covSubRenderController: CovSubRenderController;\n  protected enableLog: boolean = false;\n\n  constructor() {\n    super();\n\n    this.callMessagePrint = (\n      type: ELoggerType = ELoggerType.debug,\n      ...args: unknown[]\n    ) => {\n      if (!this.enableLog) {\n        return;\n      }\n      logger[type](formatLog(...args));\n      this.onDebugLog?.(`[${type}] ${formatLog(...args)}`);\n    };\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `${ConversationalAIAPI.NAME} initialized, version: ${ConversationalAIAPI.VERSION}`\n    );\n\n    this.covSubRenderController = new CovSubRenderController({\n      onChatHistoryUpdated: this.onChatHistoryUpdated.bind(this),\n      onAgentStateChanged: this.onAgentStateChanged.bind(this),\n      onAgentInterrupted: this.onAgentInterrupted.bind(this),\n      onDebugLog: this.onDebugLog.bind(this),\n      onAgentMetrics: this.onAgentMetrics.bind(this),\n      onAgentError: this.onAgentError.bind(this),\n      onMessageReceipt: this.onMessageReceiptUpdated.bind(this),\n      onMessageError: this.onMessageError.bind(this),\n      onMessageSalStatus: this.onMessageSalStatus.bind(this),\n    });\n  }\n\n  /**\n   * Gets the singleton instance of ConversationalAIAPI.\n   *\n   * Retrieves the singleton instance of the ConversationalAIAPI class. This method\n   * ensures that only one instance of ConversationalAIAPI exists throughout the\n   * application lifecycle.\n   *\n   * @remarks\n   * - Must call {@link init} before using this method\n   * - Throws error if instance is not initialized\n   *\n   * @returns The singleton instance of ConversationalAIAPI\n   * @throws {@link NotFoundError} When ConversationalAIAPI is not initialized\n   * @since 1.6.0\n   */\n  public static getInstance() {\n    if (!ConversationalAIAPI._instance) {\n      throw new NotFoundError(\"ConversationalAIAPI is not initialized\");\n    }\n    return ConversationalAIAPI._instance;\n  }\n\n  public getCfg() {\n    if (!this.rtcEngine || !this.rtmEngine) {\n      throw new NotFoundError(\"ConversationalAIAPI is not initialized\");\n    }\n    return {\n      rtcEngine: this.rtcEngine,\n      rtmEngine: this.rtmEngine,\n      renderMode: this.renderMode,\n      channel: this.channel,\n      enableLog: this.enableLog,\n    };\n  }\n\n  /**\n   * Initializes the ConversationalAIAPI singleton instance.\n   *\n   * This method sets up the RTC and RTM engines, render mode, and logging options.\n   * It must be called before any other methods of ConversationalAIAPI can be used.\n   *\n   * @remarks\n   * - Only one instance can be initialized at a time\n   * - Throws error if already initialized\n   *\n   * @param cfg - Configuration object for initializing the API\n   * @returns The initialized instance of ConversationalAIAPI\n   * @throws {@link Error} If ConversationalAIAPI is already initialized\n   * @since 1.6.0\n   */\n  public static init(cfg: IConversationalAIAPIConfig) {\n    if (!ConversationalAIAPI._instance) {\n      ConversationalAIAPI._instance = new ConversationalAIAPI();\n    }\n    ConversationalAIAPI._instance.rtcEngine = cfg.rtcEngine;\n    ConversationalAIAPI._instance.rtmEngine = cfg.rtmEngine;\n    ConversationalAIAPI._instance.renderMode =\n      cfg.renderMode ?? ETranscriptHelperMode.UNKNOWN;\n    ConversationalAIAPI._instance.enableLog = cfg.enableLog ?? false;\n\n    return ConversationalAIAPI._instance;\n  }\n\n  /**\n   * Subscribes to a message channel for real-time updates.\n   *\n   * This method binds the necessary RTC and RTM events, sets the channel,\n   * and starts the CovSubRenderController to handle incoming messages.\n   *\n   * @remarks\n   * - Must call {@link init} before using this method\n   * - Throws error if not initialized\n   *\n   * @param channel - The channel to subscribe to for messages\n   * @since 1.6.0\n   */\n  public async subscribeMessage(channel: string) {\n    this.bindRtcEvents();\n    this.bindRtmEvents();\n\n    // Validate and sanitize channel name for RTM v2.x\n    let validChannelName = channel;\n    if (!validChannelName || validChannelName.length === 0) {\n      validChannelName = \"default_channel\";\n    }\n    // RTM v2.x channel names should be alphanumeric and underscores, max 64 chars\n    validChannelName = validChannelName\n      .replace(/[^a-zA-Z0-9_]/g, \"_\")\n      .substring(0, 64);\n\n    this.channel = validChannelName;\n    this.covSubRenderController.setMode(this.renderMode);\n    this.covSubRenderController.run();\n\n    // Subscribe to RTM channel in v2.x using the correct API\n    try {\n      const { rtmEngine } = this.getCfg();\n      if (rtmEngine) {\n        const subscribeOptions = {\n          withMessage: true,\n          withPresence: true,\n          withMetadata: false,\n          withLock: false,\n        };\n        await rtmEngine.subscribe(this.channel, subscribeOptions);\n        console.log(\n          \"[ConversationalAIAPI] Subscribed to RTM channel:\",\n          this.channel\n        );\n      }\n    } catch (error) {\n      console.error(\n        \"[ConversationalAIAPI] Failed to subscribe to RTM channel:\",\n        error\n      );\n      throw error;\n    }\n\n  }\n\n  /**\n   * Unsubscribes from the message channel and cleans up resources.\n   *\n   * This method unbinds the RTC and RTM events, clears the channel,\n   * and cleans up the CovSubRenderController.\n   *\n   * @remarks\n   * - Must call {@link subscribeMessage} before using this method\n   * - Throws error if not initialized\n   *\n   * @since 1.6.0\n   */\n  public async unsubscribe() {\n    this.unbindRtcEvents();\n    this.unbindRtmEvents();\n\n    // Unsubscribe from RTM channel in v2.x\n    try {\n      const { rtmEngine } = this.getCfg();\n      if (rtmEngine && this.channel) {\n        await rtmEngine.unsubscribe(this.channel);\n        console.log(\n          \"[ConversationalAIAPI] Unsubscribed from RTM channel:\",\n          this.channel\n        );\n      }\n    } catch (error) {\n      console.error(\n        \"[ConversationalAIAPI] Failed to unsubscribe from RTM channel:\",\n        error\n      );\n    }\n\n    this.channel = null;\n    this.covSubRenderController.cleanup();\n\n  }\n\n  /**\n   * Destroys the ConversationalAIAPI instance and cleans up resources.\n   *\n   * This method unbinds all RTC and RTM events, clears the channel,\n   * and cleans up the CovSubRenderController.\n   *\n   * @remarks\n   * - Must call {@link unsubscribe} before using this method\n   * - Throws error if not initialized\n   *\n   * @since 1.6.0\n   */\n  public destroy() {\n    const instance = ConversationalAIAPI.getInstance();\n    if (instance) {\n      instance?.rtcEngine?.removeAllListeners();\n      instance.rtcEngine = null;\n      instance?.rtmEngine?.removeAllListeners();\n      instance.rtmEngine = null;\n      instance.renderMode = ETranscriptHelperMode.UNKNOWN;\n      instance.channel = null;\n      instance.removeAllEventListeners();\n      ConversationalAIAPI._instance = null;\n    }\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `${ConversationalAIAPI.NAME} destroyed`\n    );\n  }\n\n  /**\n   * Sends a chat message to the conversational AI agent.\n   *\n   * @param agentUserId - The unique identifier of the agent user\n   * @param message - The chat message to send, can be either text or image type\n   * @returns A promise that resolves with the result of sending the message\n   * @throws {Error} When an unsupported chat message type is provided\n   *\n   * @since 1.7.0\n   *\n   * @example\n   * ```typescript\n   * // Send a text message\n   * const textMessage: IChatMessageText = {\n   *   messageType: EChatMessageType.TEXT,\n   *   priority: EChatMessagePriority.HIGH,\n   *   responseInterruptable: true,\n   *   text: \"Hello, how are you?\"\n   * };\n   * await api.chat(\"user123\", textMessage);\n   *\n   * // Send an image message\n   * const imageMessage: IChatMessageImage = {\n   *   messageType: EChatMessageType.IMAGE,\n   *   uuid: \"msg-456\",\n   *   url: \"https://example.com/image.jpg\"\n   * };\n   * await api.chat(\"user123\", imageMessage);\n   * ```\n   */\n  public async chat(\n    agentUserId: string,\n    message: IChatMessageText | IChatMessageImage\n  ) {\n    switch (message.messageType) {\n      case EChatMessageType.TEXT:\n        return this.sendText(agentUserId, message as IChatMessageText);\n      case EChatMessageType.IMAGE:\n        return this.sendImage(agentUserId, message as IChatMessageImage);\n      default:\n        throw new Error(\"Unsupported chat message type\");\n    }\n  }\n\n  /**\n   * Sends a text message to the specified agent user through RTM engine.\n   *\n   * @param agentUserId - The unique identifier of the agent user to send the message to\n   * @param message - The chat message object containing text content and optional settings\n   * @param message.priority - Optional priority level for the message (defaults to INTERRUPTED)\n   * @param message.responseInterruptable - Optional flag indicating if the response can be interrupted (defaults to true)\n   * @param message.text - The actual text content of the message\n   *\n   * @returns Promise that resolves when the message is successfully sent\n   *\n   * @throws {Error} Throws an error with message \"failed to send chat message\" if the RTM publish operation fails\n   *\n   * @since 1.7.0\n   *\n   * @example\n   * ```typescript\n   * await api.sendText('user123', {\n   *   text: 'Hello, how can I help you?',\n   *   priority: EChatMessagePriority.HIGH,\n   *   responseInterruptable: false\n   * });\n   * ```\n   */\n  public async sendText(agentUserId: string, message: IChatMessageText) {\n    await this.interrupt(agentUserId); // interrupt the agent before sending the message\n    const traceId = genTranceID();\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> [trancID:${traceId}] [chat] ${agentUserId}`,\n      message\n    );\n\n    const { rtmEngine } = this.getCfg();\n\n    // Check if RTM engine is available and has publish method\n    if (!rtmEngine) {\n      throw new Error(\"RTM engine is not initialized\");\n    }\n\n    if (typeof (rtmEngine as any).publish !== \"function\") {\n      this.callMessagePrint(\n        ELoggerType.error,\n        `>>> [trancID:${traceId}] [chat]`,\n        \"RTM engine does not have publish method\",\n        Object.keys(rtmEngine)\n      );\n      throw new Error(\"RTM engine does not have publish method\");\n    }\n\n    const payload = {\n      priority: message.priority ?? EChatMessagePriority.INTERRUPTED,\n      interruptable: true,\n      message: message.text ?? \"\",\n    };\n\n    try {\n      const payloadStr = JSON.stringify(payload);\n      const options = {\n        channelType: \"USER\" as ChannelType,\n        customType: EMessageType.USER_TRANSCRIPTION,\n      };\n\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `msg: [traceID: ${traceId}] rtm publish`,\n        payloadStr\n      );\n\n      // Check if publish method exists, if not try alternative methods\n      let result;\n      if (typeof (rtmEngine as any).publish === \"function\") {\n        result = await (rtmEngine as any).publish(\n          agentUserId,\n          payloadStr,\n          options\n        );\n      } else if (typeof (rtmEngine as any).sendMessageToPeer === \"function\") {\n        // Fallback to sendMessageToPeer if publish doesn't exist\n        result = await (rtmEngine as any).sendMessageToPeer(\n          agentUserId,\n          payloadStr\n        );\n      } else {\n        throw new Error(\n          \"RTM client does not have publish or sendMessageToPeer method\"\n        );\n      }\n\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `>>> [trancID:${traceId}] [chat]`,\n        \"sucessfully sent chat message\",\n        result\n      );\n    } catch (error: unknown) {\n      const errorMessage =\n        error instanceof Error ? error.message : String(error);\n      const errorDetails =\n        error instanceof Error ? error.stack : JSON.stringify(error);\n      this.callMessagePrint(\n        ELoggerType.error,\n        `>>> [trancID:${traceId}] [chat]`,\n        \"failed to send chat message\",\n        errorMessage,\n        errorDetails\n      );\n      throw new Error(`failed to send chat message: ${errorMessage}`);\n    }\n  }\n\n  /**\n   * Sends an image message to a specific agent user through RTM (Real-Time Messaging).\n   *\n   * @param agentUserId - The unique identifier of the agent user to send the image to\n   * @param message - The image message object containing UUID and either URL or base64 data\n   * @param message.uuid - Unique identifier for the message\n   * @param message.url - Optional URL of the image to send\n   * @param message.base64 - Optional base64 encoded image data\n   *\n   * @throws {Error} Throws an error with message \"failed to send chat message\" if the RTM publish operation fails\n   *\n   * @returns Promise that resolves when the image message is successfully sent\n   *\n   * @since 1.7.0\n   *\n   * @example\n   * ```typescript\n   * await sendImage('user123', {\n   *   uuid: 'msg-456',\n   *   url: 'https://example.com/image.jpg'\n   * });\n   * ```\n   */\n  public async sendImage(agentUserId: string, message: IChatMessageImage) {\n    const traceId = genTranceID();\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> [trancID:${traceId}] [chat] ${agentUserId}`,\n      message\n    );\n\n    const { rtmEngine } = this.getCfg();\n\n    const payload = {\n      uuid: message.uuid,\n      image_url: message?.url || \"\",\n      image_base64: message?.base64 || \"\",\n    };\n\n    try {\n      const payloadStr = JSON.stringify(payload);\n      const options = {\n        channelType: \"USER\" as ChannelType,\n        customType: EMessageType.IMAGE_UPLOAD,\n      };\n\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `msg: [traceID: ${traceId}] rtm publish`,\n        payloadStr\n      );\n\n      const result = await rtmEngine.publish(agentUserId, payloadStr, options);\n\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `>>> [trancID:${traceId}] [chat]`,\n        \"sucessfully sent chat message\",\n        result\n      );\n    } catch (error: unknown) {\n      this.callMessagePrint(\n        ELoggerType.error,\n        `>>> [trancID:${traceId}] [chat]`,\n        \"failed to send chat message\",\n        error\n      );\n      throw new Error(\"failed to send chat message\");\n    }\n  }\n\n  /**\n   * Sends an interrupt message to the specified agent user.\n   *\n   * This method publishes an interrupt message to the RTM channel of the specified agent user.\n   * It is used to signal that the current interaction should be interrupted.\n   *\n   * @remarks\n   * - Must call {@link init} before using this method\n   * - Throws error if not initialized or if sending fails\n   *\n   * @param agentUserId - The user ID of the agent to interrupt\n   * @since 1.6.0\n   */\n  public async interrupt(agentUserId: string) {\n    const traceId = genTranceID();\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> [trancID:${traceId}] [interrupt]`,\n      agentUserId\n    );\n\n    const { rtmEngine } = this.getCfg();\n\n    const options = {\n      channelType: \"USER\" as ChannelType,\n      customType: EMessageType.MSG_INTERRUPTED,\n    };\n    const messageStr = JSON.stringify({\n      customType: EMessageType.MSG_INTERRUPTED,\n    });\n\n    try {\n      const result = await rtmEngine.publish(agentUserId, messageStr, options);\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `>>> [trancID:${traceId}] [interrupt]`,\n        \"sucessfully sent interrupt message\",\n        result\n      );\n    } catch (error: unknown) {\n      this.callMessagePrint(\n        ELoggerType.error,\n        `>>> [trancID:${traceId}] [interrupt]`,\n        \"failed to send interrupt message\",\n        error\n      );\n      throw new Error(\"failed to send interrupt message\");\n    }\n  }\n\n  private onChatHistoryUpdated(\n    chatHistory: ITranscriptHelperItem<\n      Partial<IUserTranscription | IAgentTranscription>\n    >[]\n  ) {\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> ${EConversationalAIAPIEvents.TRANSCRIPT_UPDATED}`,\n      chatHistory\n    );\n    // Always emit, even if logging is disabled\n    console.log(\n      \"[ConversationalAIAPI] Emitting TRANSCRIPT_UPDATED:\",\n      chatHistory\n    );\n    this.emit(EConversationalAIAPIEvents.TRANSCRIPT_UPDATED, chatHistory);\n  }\n  private onAgentStateChanged(agentUserId: string, event: TStateChangeEvent) {\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> ${EConversationalAIAPIEvents.AGENT_STATE_CHANGED}`,\n      agentUserId,\n      event\n    );\n    this.emit(\n      EConversationalAIAPIEvents.AGENT_STATE_CHANGED,\n      agentUserId,\n      event\n    );\n  }\n  private onAgentInterrupted(\n    agentUserId: string,\n    event: { turnID: number; timestamp: number }\n  ) {\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> ${EConversationalAIAPIEvents.AGENT_INTERRUPTED}`,\n      agentUserId,\n      event\n    );\n    this.emit(EConversationalAIAPIEvents.AGENT_INTERRUPTED, agentUserId, event);\n  }\n  private onDebugLog(message: string) {\n    this.emit(EConversationalAIAPIEvents.DEBUG_LOG, message);\n  }\n  private onAgentMetrics(agentUserId: string, metrics: TAgentMetric) {\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> ${EConversationalAIAPIEvents.AGENT_METRICS}`,\n      agentUserId,\n      metrics\n    );\n    this.emit(EConversationalAIAPIEvents.AGENT_METRICS, agentUserId, metrics);\n  }\n  private onAgentError(agentUserId: string, error: TModuleError) {\n    this.callMessagePrint(\n      ELoggerType.error,\n      `>>> ${EConversationalAIAPIEvents.AGENT_ERROR}`,\n      agentUserId,\n      error\n    );\n    this.emit(EConversationalAIAPIEvents.AGENT_ERROR, agentUserId, error);\n  }\n  private onMessageReceiptUpdated(\n    agentUserId: string,\n    messageReceipt: TMessageReceipt\n  ) {\n    this.callMessagePrint(\n      ELoggerType.error,\n      `>>> ${EConversationalAIAPIEvents.MESSAGE_RECEIPT_UPDATED}`,\n      agentUserId,\n      messageReceipt\n    );\n    this.emit(\n      EConversationalAIAPIEvents.MESSAGE_RECEIPT_UPDATED,\n      agentUserId,\n      messageReceipt\n    );\n  }\n  private onMessageError(\n    agentUserId: string,\n    error: {\n      type: EChatMessageType;\n      code: number;\n      message: string;\n      timestamp: number;\n    }\n  ) {\n    this.callMessagePrint(\n      ELoggerType.error,\n      `>>> ${EConversationalAIAPIEvents.MESSAGE_ERROR}`,\n      agentUserId,\n      error\n    );\n    this.emit(EConversationalAIAPIEvents.MESSAGE_ERROR, agentUserId, error);\n  }\n\n  private onMessageSalStatus(agentUserId: string, message: IMessageSalStatus) {\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> ${EConversationalAIAPIEvents.MESSAGE_SAL_STATUS}`,\n      agentUserId,\n      message\n    );\n    this.emit(\n      EConversationalAIAPIEvents.MESSAGE_SAL_STATUS,\n      agentUserId,\n      message\n    );\n  }\n\n  private bindRtcEvents() {\n    // this.getCfg().rtcEngine.on(\n    //   ERTCEvents.AUDIO_METADATA,\n    //   this._handleRtcAudioMetadata.bind(this)\n    // )\n    this.getCfg().rtcEngine.on(\n      ERTCEvents.AUDIO_PTS,\n      this._handleRtcAudioPTS.bind(this)\n    );\n  }\n  private unbindRtcEvents() {\n    // this.getCfg().rtcEngine.off(\n    //   ERTCEvents.AUDIO_METADATA,\n    //   this._handleRtcAudioMetadata.bind(this)\n    // )\n    this.getCfg().rtcEngine.off(\n      ERTCEvents.AUDIO_PTS,\n      this._handleRtcAudioPTS.bind(this)\n    );\n  }\n  private bindRtmEvents() {\n    // - message\n    this.getCfg().rtmEngine.addEventListener(\n      ERTMEvents.MESSAGE,\n      this._handleRtmMessage.bind(this)\n    );\n    // - presence\n    this.getCfg().rtmEngine.addEventListener(\n      ERTMEvents.PRESENCE,\n      this._handleRtmPresence.bind(this)\n    );\n    // - status\n    this.getCfg().rtmEngine.addEventListener(\n      ERTMEvents.STATUS,\n      this._handleRtmStatus.bind(this)\n    );\n  }\n  private unbindRtmEvents() {\n    // - message\n    this.getCfg().rtmEngine.removeEventListener(\n      ERTMEvents.MESSAGE,\n      this._handleRtmMessage.bind(this)\n    );\n    // - presence\n    this.getCfg().rtmEngine.removeEventListener(\n      ERTMEvents.PRESENCE,\n      this._handleRtmPresence.bind(this)\n    );\n    // - status\n    this.getCfg().rtmEngine.removeEventListener(\n      ERTMEvents.STATUS,\n      this._handleRtmStatus.bind(this)\n    );\n  }\n\n  // private _handleRtcAudioMetadata(metadata: Uint8Array) {\n  //   try {\n  //     const pts64 = Number(new DataView(metadata.buffer).getBigUint64(0, true))\n  //     this.callMessagePrint(\n  //       ELoggerType.debug,\n  //       `<<< ${ERTCEvents.AUDIO_METADATA}`,\n  //       pts64\n  //     )\n  //     this.covSubRenderController.setPts(pts64)\n  //   } catch (error) {\n  //     this.callMessagePrint(\n  //       ELoggerType.error,\n  //       `<<< ${ERTCEvents.AUDIO_METADATA}`,\n  //       metadata,\n  //       error\n  //     )\n  //   }\n  // }\n\n  private _handleRtcAudioPTS(pts: number) {\n    try {\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `<<< ${ERTCEvents.AUDIO_PTS}`,\n        pts\n      );\n      this.covSubRenderController.setPts(pts);\n    } catch (error) {\n      this.callMessagePrint(\n        ELoggerType.error,\n        `<<< ${ERTCEvents.AUDIO_PTS}`,\n        pts,\n        error\n      );\n    }\n  }\n\n  private _handleRtmMessage(message: RTMEvents.MessageEvent) {\n    const traceId = genTranceID();\n    // Debug: Uncomment if needed for ASR debugging\n    // console.log(\"[ConversationalAIAPI] RTM message received:\", { publisher: message.publisher, messageType: message.messageType, traceId });\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> [trancID:${traceId}] ${ERTMEvents.MESSAGE}`,\n      `Publisher: ${message.publisher}, type: ${message.messageType}`\n    );\n    // Handle the message\n    try {\n      const messageData = message.message;\n      // if string, parse it\n      if (typeof messageData === \"string\") {\n        const parsedMessage = JSON.parse(messageData);\n        // Debug: Uncomment if needed\n        // console.log(\"[ConversationalAIAPI] Parsed RTM message (string):\", parsedMessage);\n        this.callMessagePrint(\n          ELoggerType.debug,\n          `>>> [trancID:${traceId}] ${ERTMEvents.MESSAGE}`,\n          parsedMessage\n        );\n        this.covSubRenderController.handleMessage(parsedMessage, {\n          publisher: message.publisher,\n        });\n        return;\n      }\n      // if Uint8Array, convert to string\n      if (messageData instanceof Uint8Array) {\n        const decoder = new TextDecoder(\"utf-8\");\n        const messageString = decoder.decode(messageData);\n        const parsedMessage = JSON.parse(messageString);\n        // Debug: Uncomment if needed\n        // console.log(\"[ConversationalAIAPI] Parsed RTM message (Uint8Array):\", parsedMessage);\n        this.callMessagePrint(\n          ELoggerType.debug,\n          `>>> [trancID:${traceId}] ${ERTMEvents.MESSAGE}`,\n          parsedMessage\n        );\n        this.covSubRenderController.handleMessage(parsedMessage, {\n          publisher: message.publisher,\n        });\n        return;\n      }\n      console.warn(\n        \"[ConversationalAIAPI] Unsupported message type:\",\n        typeof messageData,\n        messageData\n      );\n      this.callMessagePrint(\n        ELoggerType.warn,\n        `>>> [trancID:${traceId}] ${ERTMEvents.MESSAGE}`,\n        \"Unsupported message type received\"\n      );\n    } catch (error) {\n      console.error(\n        \"[ConversationalAIAPI] Failed to parse RTM message:\",\n        error,\n        message\n      );\n      this.callMessagePrint(\n        ELoggerType.error,\n        `>>> [trancID:${traceId}] ${ERTMEvents.MESSAGE}`,\n        \"Failed to parse message\",\n        error\n      );\n    }\n  }\n  private _handleRtmPresence(presence: RTMEvents.PresenceEvent) {\n    const traceId = genTranceID();\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> [trancID:${traceId}] ${ERTMEvents.PRESENCE}`,\n      `Publisher: ${presence.publisher}`\n    );\n    // Handle the presence event\n    const stateChanged = presence.stateChanged;\n    if (stateChanged?.state && stateChanged?.turn_id) {\n      this.callMessagePrint(\n        ELoggerType.debug,\n        `>>> [trancID:${traceId}] ${ERTMEvents.PRESENCE}`,\n        `State changed: ${stateChanged.state}, Turn ID: ${stateChanged.turn_id}, timestamp: ${presence.timestamp}`\n      );\n      this.covSubRenderController.handleAgentStatus(\n        presence as Omit<RTMEvents.PresenceEvent, \"stateChanged\"> & {\n          stateChanged: {\n            state: EAgentState;\n            turn_id: string;\n          };\n        }\n      );\n    }\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> [trancID:${traceId}] ${ERTMEvents.PRESENCE}`,\n      \"No state change detected, skipping handling presence event\"\n    );\n  }\n  private _handleRtmStatus(\n    status:\n      | RTMEvents.RTMConnectionStatusChangeEvent\n      | RTMEvents.StreamChannelConnectionStatusChangeEvent\n  ) {\n    const traceId = genTranceID();\n    this.callMessagePrint(\n      ELoggerType.debug,\n      `>>> [trancID:${traceId}] ${ERTMEvents.STATUS}`,\n      status\n    );\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2172, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/components/ChatInterface.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useRef, useEffect } from \"react\";\nimport { useAgora } from \"@/hooks/useAgora\";\nimport { ConversationalAIAPI } from \"@/lib/conversational-ai-api\";\nimport {\n  EConversationalAIAPIEvents,\n  ETranscriptHelperMode,\n  EChatMessagePriority,\n  EChatMessageType,\n  ETurnStatus,\n  type ITranscriptHelperItem,\n  type IChatMessageText,\n} from \"@/lib/conversational-ai-api/type\";\n\ninterface Product {\n  id: string;\n  name: string;\n}\n\ninterface ChatMessage {\n  role: \"user\" | \"assistant\";\n  content: string;\n  uid?: string;\n  turnId?: number; // Track turn_id to replace intermediate messages\n  turn_id?: number; // Also include as turn_id for compatibility\n  timestamp?: number; // Include timestamp for sorting\n  isLoading?: boolean; // Flag to show loading animation\n}\n\ninterface ChatInterfaceProps {\n  product: Product;\n  onClose: () => void;\n}\n\nexport function ChatInterface({ product, onClose }: ChatInterfaceProps) {\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\n  const [input, setInput] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [isInitializing, setIsInitializing] = useState(true);\n  const [agentVolume, setAgentVolume] = useState(100); // Agent volume (0-100)\n  const [waitingForAgent, setWaitingForAgent] = useState(false); // Track if we're waiting for agent response\n  const [isMinimized, setIsMinimized] = useState(false); // Minimized state\n  const [microphones, setMicrophones] = useState<MediaDeviceInfo[]>([]); // Available microphones\n  const [selectedMicrophone, setSelectedMicrophone] = useState<string>(\"\"); // Selected microphone ID\n  const [agoraConfig, setAgoraConfig] = useState<{\n    appId: string;\n    channel: string;\n    token: string;\n    uid: number;\n    rtmUserId: string;\n  } | null>(null);\n  const [agentId, setAgentId] = useState<string | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const isInitializingRef = useRef(false);\n  const rtmClientRef = useRef<any>(null);\n  const convoApiRef = useRef<ConversationalAIAPI | null>(null);\n  const videoContainerRef = useRef<HTMLDivElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const videoElementRef = useRef<HTMLVideoElement | null>(null);\n  const animationFrameRef = useRef<number | null>(null);\n\n  // Initialize Agora RTC connection\n  const agora = useAgora(\n    agoraConfig\n      ? {\n          appId: agoraConfig.appId,\n          channel: agoraConfig.channel,\n          token: agoraConfig.token,\n          uid: agoraConfig.uid,\n        }\n      : {\n          appId: \"\",\n          channel: \"\",\n          token: \"\",\n          uid: 0,\n        }\n  );\n\n  // Render video to canvas with transparent background (chroma key removal)\n  useEffect(() => {\n    if (!agora?.remoteVideoTrack || !canvasRef.current) return;\n\n    const canvas = canvasRef.current;\n    const ctx = canvas.getContext(\"2d\", { willReadFrequently: true });\n    if (!ctx) return;\n\n    // Create a hidden video element to play the track\n    const videoElement = document.createElement(\"video\");\n    videoElement.autoplay = true;\n    videoElement.playsInline = true;\n    videoElement.style.display = \"none\";\n    document.body.appendChild(videoElement);\n    videoElementRef.current = videoElement;\n\n    // Play the video track on the hidden element\n    agora.remoteVideoTrack.play(videoElement);\n\n    // Function to apply chroma key (green screen removal) - using improved algorithm\n    const applyChromaKey = (imageData: ImageData) => {\n      const data = imageData.data;\n      const greenThreshold = 100;\n\n      for (let i = 0; i < data.length; i += 4) {\n        const r = data[i];\n        const g = data[i + 1];\n        const b = data[i + 2];\n\n        // Check if pixel is green (green screen detection)\n        // Green is significantly more than red and blue\n        const isGreen = g > greenThreshold && g > r * 1.2 && g > b * 1.2;\n\n        if (isGreen) {\n          data[i + 3] = 0; // Make transparent\n        }\n      }\n\n      return imageData;\n    };\n\n    // Function to draw frame with chroma key\n    const drawFrame = () => {\n      if (!videoElement || videoElement.readyState !== videoElement.HAVE_ENOUGH_DATA) {\n        animationFrameRef.current = requestAnimationFrame(drawFrame);\n        return;\n      }\n\n      // Get actual video dimensions\n      const videoWidth = videoElement.videoWidth;\n      const videoHeight = videoElement.videoHeight;\n      \n      if (videoWidth === 0 || videoHeight === 0) {\n        animationFrameRef.current = requestAnimationFrame(drawFrame);\n        return;\n      }\n\n      // Container dimensions\n      const containerWidth = 320; // w-80 = 320px\n      const containerHeight = 240; // h-[240px]\n      \n      // Calculate aspect ratios\n      const aspectRatio = videoWidth / videoHeight;\n      \n      // Calculate dimensions to maintain aspect ratio (fit within container)\n      let drawWidth = containerWidth;\n      let drawHeight = containerWidth / aspectRatio;\n      let offsetX = 0;\n      let offsetY = 0;\n      \n      // If height exceeds container, scale to fit height instead\n      if (drawHeight > containerHeight) {\n        drawHeight = containerHeight;\n        drawWidth = containerHeight * aspectRatio;\n        offsetX = (containerWidth - drawWidth) / 2;\n      } else {\n        offsetY = (containerHeight - drawHeight) / 2;\n      }\n      \n      // Set canvas size to match video dimensions for better quality\n      canvas.width = videoWidth;\n      canvas.height = videoHeight;\n\n      // Clear canvas\n      ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n      // Draw video frame to canvas at full resolution\n      ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);\n\n      // Get image data and apply chroma key\n      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n      const processedImageData = applyChromaKey(imageData);\n      ctx.putImageData(processedImageData, 0, 0);\n\n      // Continue animation loop\n      animationFrameRef.current = requestAnimationFrame(drawFrame);\n    };\n\n    // Start the animation loop when video metadata is loaded\n    videoElement.addEventListener(\"loadedmetadata\", () => {\n      drawFrame();\n    });\n    \n    // Also start if video is already loaded\n    if (videoElement.readyState >= videoElement.HAVE_METADATA) {\n      drawFrame();\n    }\n\n    // Cleanup function\n    return () => {\n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n        animationFrameRef.current = null;\n      }\n      if (agora?.remoteVideoTrack) {\n        agora.remoteVideoTrack.stop();\n      }\n      if (videoElementRef.current) {\n        videoElementRef.current.remove();\n        videoElementRef.current = null;\n      }\n    };\n  }, [agora?.remoteVideoTrack]);\n\n  // Update agent volume when remote audio track changes or volume changes\n  useEffect(() => {\n    if (agora?.remoteAudioTrack) {\n      agora.remoteAudioTrack.setVolume(agentVolume);\n    }\n  }, [agora?.remoteAudioTrack, agentVolume]);\n\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  // Initialize Agora session on mount\n  useEffect(() => {\n    const initializeAgora = async () => {\n      if (isInitializingRef.current) return;\n      isInitializingRef.current = true;\n      try {\n        // Initialize Agora session\n        const initRes = await fetch(\"/api/agora/initialize\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            userId: Math.floor(Math.random() * 100000),\n          }),\n        });\n\n        const initData = await initRes.json();\n        setAgoraConfig({\n          appId: initData.appId,\n          channel: initData.channel,\n          token: initData.token,\n          uid: initData.uid,\n          rtmUserId: initData.rtmUserId || initData.uid.toString(),\n        });\n\n        // Start AI agent\n        const agentRes = await fetch(\"/api/agora/start-agent\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            channel: initData.channel,\n            userId: initData.uid,\n            token: initData.token,\n            productId: product.id, // Pass product ID so AI knows which product to discuss\n          }),\n        });\n\n        if (!agentRes.ok) {\n          const errorData = await agentRes.json();\n          throw new Error(\n            errorData.error || `Failed to start agent: ${agentRes.status}`\n          );\n        }\n\n        const agentData = await agentRes.json();\n\n        if (agentData.agent_id) {\n          setAgentId(agentData.agent_id);\n        }\n\n        // Set greeting message from ConvoAI if available\n        // Store it with uid so it doesn't get overwritten by transcript updates\n        const greetingMessage =\n          agentData.greeting_message ||\n          agentData.properties?.llm?.greeting_message;\n        if (greetingMessage) {\n          setMessages([\n            {\n              role: \"assistant\",\n              content: greetingMessage,\n              uid: \"1000\", // Agent UID\n            },\n          ]);\n        }\n\n        setIsInitializing(false);\n      } catch (error) {\n        console.error(\"Failed to initialize Agora:\", error);\n        setIsInitializing(false);\n      }\n    };\n\n    initializeAgora();\n  }, [product.id]);\n\n  // Get available microphones using Agora SDK\n  useEffect(() => {\n    const getMicrophones = async () => {\n      try {\n        if (!agora?.localAudioTrack) return;\n\n        const AgoraRTC = (await import(\"agora-rtc-sdk-ng\")).default;\n        // Use Agora's getMicrophones method\n        const mics = await AgoraRTC.getMicrophones();\n        setMicrophones(mics);\n\n        if (mics.length > 0 && !selectedMicrophone) {\n          // Set the first microphone as default\n          setSelectedMicrophone(mics[0].deviceId);\n        }\n      } catch (error) {\n        console.error(\"Error getting microphones:\", error);\n      }\n    };\n\n    if (\n      typeof window !== \"undefined\" &&\n      agora?.isConnected &&\n      agora?.localAudioTrack\n    ) {\n      getMicrophones();\n    }\n  }, [agora?.isConnected, agora?.localAudioTrack]);\n\n  // Initialize RTM and ConversationalAIAPI toolkit\n  useEffect(() => {\n    if (\n      !agoraConfig ||\n      !agora?.client ||\n      typeof window === \"undefined\" ||\n      convoApiRef.current\n    ) {\n      return;\n    }\n\n    let isMounted = true;\n\n    const initToolkit = async () => {\n      try {\n        // Initialize RTM client\n        const AgoraRTM = await import(\"agora-rtm-sdk\");\n        const RTM =\n          (AgoraRTM.default as any)?.RTM ||\n          (AgoraRTM as any).RTM ||\n          AgoraRTM.default;\n\n        if (!RTM || typeof RTM !== \"function\") {\n          throw new Error(\"Failed to get RTM class\");\n        }\n\n        const rtmClient = new RTM(agoraConfig.appId, agoraConfig.rtmUserId);\n        rtmClientRef.current = rtmClient;\n\n        await rtmClient.login({ token: agoraConfig.token });\n\n        if (!isMounted) {\n          await rtmClient.logout().catch(() => {});\n          return;\n        }\n\n        // Initialize ConversationalAIAPI toolkit\n        const convoAPI = ConversationalAIAPI.init({\n          rtcEngine: agora.client!,\n          rtmEngine: rtmClient as any,\n          renderMode: ETranscriptHelperMode.TEXT,\n          enableLog: true, // Enable logging to debug\n        });\n\n        convoApiRef.current = convoAPI;\n\n        // Subscribe to channel messages (required before agent starts)\n        await convoAPI.subscribeMessage(agoraConfig.channel);\n\n        // Listen for transcript updates (both user and agent)\n        // Use the EventHelper's on method properly\n        const transcriptHandler = (\n          transcripts: ITranscriptHelperItem<any>[]\n        ) => {\n          if (!isMounted) return;\n\n          // Get user's UID for comparison\n          const userRtcUid = agoraConfig?.uid?.toString() || \"\";\n          const userRtmUid = agoraConfig?.rtmUserId || \"\";\n\n          const newMessages: ChatMessage[] = transcripts\n            .filter((item) => {\n              // Check if item has text - could be in item.text or (item as any).data?.text (Frank's structure)\n              const itemAny = item as any;\n              const hasText =\n                (item.text && item.text.trim()) ||\n                (itemAny.data?.text && itemAny.data.text.trim());\n\n              // Only show final messages (not intermediate/transcribing ones)\n              const isFinal =\n                item.status === ETurnStatus.END ||\n                itemAny.data?.isFinal === true ||\n                itemAny.data?.final === true ||\n                (itemAny.status && String(itemAny.status) === \"final\");\n\n              if (!hasText) {\n                return false;\n              }\n\n              // IMPORTANT: Check for user transcription FIRST to avoid misidentifying\n              // User transcriptions can come in different formats:\n              // 1. metadata.object === \"user.transcription\"\n              // 2. data.speaker includes \"user\"\n              // 3. UID matches the user's RTC UID (not \"1000\" which is agent)\n              // 4. publisher matches user's RTM user ID\n              const itemUid = String(\n                item.uid ||\n                  itemAny.agentUserId ||\n                  itemAny.data?.agentUserId ||\n                  itemAny.publisher ||\n                  \"unknown\"\n              );\n\n              // Check if UID matches user's UID (either RTC or RTM)\n              const matchesUserUid = \n                itemUid === userRtcUid || \n                itemUid === userRtmUid ||\n                String(item.uid) === userRtcUid ||\n                String(itemAny.publisher) === userRtmUid;\n\n              // Check if UID is NOT the agent (agent is always \"1000\")\n              const isNotAgentUid = itemUid !== \"1000\" && itemUid !== \"unknown\";\n\n              const isUserMessage =\n                item.metadata?.object === \"user.transcription\" ||\n                itemAny.data?.speaker?.toLowerCase().includes(\"user\") ||\n                itemAny.object === \"user.transcription\" ||\n                matchesUserUid ||\n                (isNotAgentUid && \n                 itemUid !== \"\" && \n                 !item.metadata?.object?.includes(\"assistant\") &&\n                 !itemAny.data?.speaker?.toLowerCase().includes(\"assistant\"));\n\n              const isAgentMessage =\n                !isUserMessage &&\n                (itemUid === \"1000\" ||\n                  item.metadata?.object === \"assistant.transcription\" ||\n                  itemAny.object === \"assistant.transcription\" ||\n                  itemAny.data?.speaker?.toLowerCase().includes(\"assistant\") ||\n                  (item.metadata && \"quiet\" in item.metadata));\n\n              // Show ALL user messages (including intermediate) so voice transcriptions don't disappear\n              // Show ALL agent messages (including intermediate) for real-time updates\n              // We'll handle deduplication in the message update logic below\n              // Only filter out if it's neither user nor agent\n              if (!isUserMessage && !isAgentMessage) {\n                return false;\n              }\n\n              return true;\n            })\n            .map((item) => {\n              // Support both our structure (item.text) and Frank's structure (item.data.text)\n              const itemAny = item as any;\n              const text = item.text || itemAny.data?.text || \"\";\n              const itemUid = String(\n                item.uid ||\n                  itemAny.agentUserId ||\n                  itemAny.data?.agentUserId ||\n                  itemAny.publisher ||\n                  \"unknown\"\n              );\n\n              // IMPORTANT: Check for user transcription FIRST to avoid misidentifying user messages as agent\n              // Use the same detection logic as in the filter above\n              const matchesUserUid = \n                itemUid === userRtcUid || \n                itemUid === userRtmUid ||\n                String(item.uid) === userRtcUid ||\n                String(itemAny.publisher) === userRtmUid;\n\n              const isNotAgentUid = itemUid !== \"1000\" && itemUid !== \"unknown\";\n\n              const isUserMessage =\n                item.metadata?.object === \"user.transcription\" ||\n                itemAny.data?.speaker?.toLowerCase().includes(\"user\") ||\n                itemAny.object === \"user.transcription\" ||\n                matchesUserUid ||\n                (isNotAgentUid && \n                 itemUid !== \"\" && \n                 !item.metadata?.object?.includes(\"assistant\") &&\n                 !itemAny.data?.speaker?.toLowerCase().includes(\"assistant\"));\n\n              // Check if it's agent: UID is \"1000\" or the metadata indicates it's an agent transcription\n              // Only mark as agent if it's NOT a user message\n              const isAgent =\n                !isUserMessage &&\n                (itemUid === \"1000\" ||\n                  item.metadata?.object === \"assistant.transcription\" ||\n                  itemAny.object === \"assistant.transcription\" ||\n                  itemAny.data?.speaker?.toLowerCase().includes(\"assistant\") ||\n                  (item.metadata && \"quiet\" in item.metadata)); // Agent transcriptions have \"quiet\" field\n\n              // Debug: Uncomment if needed for ASR debugging\n              // console.log(\"[ChatInterface] Transcript item:\", { itemUid, text: text.substring(0, 50), isUserMessage, isAgent });\n              return {\n                role: isAgent ? \"assistant\" : \"user\",\n                content: text,\n                uid: itemUid,\n                turnId: item.turn_id, // Include turn_id for tracking\n                turn_id: item.turn_id, // Also include as turn_id for compatibility\n                timestamp: item._time || Date.now(), // Include timestamp for sorting\n              } as ChatMessage & {\n                turnId?: number;\n                turn_id?: number;\n                timestamp?: number;\n              };\n            });\n\n          // Debug: Uncomment if needed\n          // console.log(\"[ChatInterface] New messages from transcripts:\", newMessages);\n\n          // Check if we have any agent messages to clear waiting state\n          const hasAgentMessage = newMessages.some(\n            (msg) => msg.role === \"assistant\" && msg.content.trim()\n          );\n          if (hasAgentMessage) {\n            setWaitingForAgent(false);\n          }\n\n          // Update messages, tracking by turn_id to replace intermediate messages with final ones\n          setMessages((prev) => {\n            // FIRST: Remove ALL loading messages from prev - they will be replaced by actual transcripts\n            const prevWithoutLoading = prev.filter((msg) => !msg.isLoading);\n\n            // Use a single map to track messages by key, preserving order\n            const messagesMap = new Map<string, ChatMessage>();\n\n            // First, add all existing messages from prev (without loading ones)\n            // Use index as part of key to ensure uniqueness and preserve order\n            prevWithoutLoading.forEach((msg, index) => {\n              const turnId = (msg as any).turnId || (msg as any).turn_id;\n              // Include role and index in key to prevent collisions between user and agent messages\n              const key =\n                turnId !== undefined && turnId !== null && turnId !== -1\n                  ? `${msg.role}-${msg.uid || \"unknown\"}-${turnId}`\n                  : `${msg.role}-${msg.uid || \"unknown\"}-${index}-${\n                      msg.content || \"no-content\"\n                    }`;\n              messagesMap.set(key, msg);\n            });\n\n            // Then, update/add new messages (this will replace existing ones with same key)\n            newMessages.forEach((msg) => {\n              if (!msg.content.trim()) return;\n\n              const itemAny = msg as any;\n              const turnId = itemAny.turnId || itemAny.turn_id;\n\n              // For user messages, FIRST find and delete ANY loading message from this user\n              // This must happen before key generation to ensure loading messages are removed\n              if (msg.role === \"user\" && msg.uid) {\n                let loadingKeysToDelete: string[] = [];\n                let shouldSkip = false;\n\n                // Find ALL loading messages from this user and mark them for deletion\n                for (const [\n                  existingKey,\n                  existingMsg,\n                ] of messagesMap.entries()) {\n                  const isLoading = existingMsg.isLoading === true;\n                  const isUser = existingMsg.role === \"user\";\n                  const sameUid = String(existingMsg.uid) === String(msg.uid);\n                  const exactContentMatch =\n                    existingMsg.content.trim().toLowerCase() ===\n                    msg.content.trim().toLowerCase();\n\n                  if (!isUser || !sameUid) {\n                    continue; // Skip messages that don't match user/uid\n                  }\n\n                  // If it's a loading message, mark it for deletion\n                  if (isLoading) {\n                    loadingKeysToDelete.push(existingKey);\n                  } else if (exactContentMatch && !isLoading) {\n                    // Exact duplicate (non-loading) - skip adding this transcript\n                    shouldSkip = true;\n                    break; // Found duplicate, exit loop\n                  }\n                }\n\n                // Delete ALL loading messages found (do this after the loop to avoid modifying while iterating)\n                loadingKeysToDelete.forEach((key) => {\n                  messagesMap.delete(key);\n                });\n\n                if (shouldSkip) {\n                  return; // Don't add this message at all - we already have it\n                }\n              }\n\n              // Now generate the key for this message\n              // Include role in key to prevent collisions between user and agent messages\n              const key =\n                turnId !== undefined && turnId !== null && turnId !== -1\n                  ? `${msg.role}-${msg.uid || \"unknown\"}-${turnId}`\n                  : `${msg.role}-${msg.uid || \"unknown\"}-${\n                      msg.content || \"no-content\"\n                    }`;\n\n              const existingMsg = messagesMap.get(key);\n\n              if (existingMsg) {\n                // Only replace if it's the same role (user messages should only replace user messages, etc.)\n                // This prevents agent messages from overwriting user messages and vice versa\n                if (existingMsg.role === msg.role) {\n                  // Replace existing message with same turn_id and role\n                  // For agent messages, always update (for real-time streaming)\n                  // For user messages, always update (to replace intermediate with final, or update final)\n                  const isAgentMsg = msg.role === \"assistant\";\n\n                  // Always update - for agents it's real-time, for users we want final versions\n                  messagesMap.set(key, msg);\n                } else {\n                  // Different role - this shouldn't happen with the new key format, but log it just in case\n                  console.warn(\n                    \"[ChatInterface] Key collision detected between different roles:\",\n                    {\n                      key,\n                      existingRole: existingMsg.role,\n                      newRole: msg.role,\n                      existingContent: existingMsg.content.substring(0, 50),\n                      newContent: msg.content.substring(0, 50),\n                    }\n                  );\n                  // Add the new message with a modified key to avoid collision\n                  const uniqueKey = `${key}-${Date.now()}`;\n                  messagesMap.set(uniqueKey, msg);\n                }\n              } else {\n                // New message with this key (loading message already deleted if found)\n                messagesMap.set(key, msg);\n              }\n            });\n\n            // Convert to array for sorting\n            const uniqueMessages = Array.from(messagesMap.values());\n\n            // FINAL SAFETY CHECK: Remove any remaining loading messages\n            const messagesWithoutLoading = uniqueMessages.filter(\n              (msg) => !msg.isLoading\n            );\n\n            // Sort messages by timestamp first (chronological order), then by turn_id as fallback\n            // This ensures messages appear in the order they were actually sent/received\n            const sortedMessages = messagesWithoutLoading.sort((a, b) => {\n              // Primary sort: timestamp (actual chronological order)\n              const timestampA = (a as any).timestamp || 0;\n              const timestampB = (b as any).timestamp || 0;\n\n              if (timestampA !== timestampB) {\n                return timestampA - timestampB; // Ascending: older first, newer at bottom\n              }\n\n              // Secondary sort: turn_id (if timestamps are the same)\n              const turnIdA = (a as any).turnId || (a as any).turn_id || 0;\n              const turnIdB = (b as any).turnId || (b as any).turn_id || 0;\n              return turnIdA - turnIdB;\n            });\n\n            console.log(\n              \"[ChatInterface] Updated messages (sorted, loading removed):\",\n              sortedMessages\n            );\n            return sortedMessages;\n          });\n        };\n\n        // Subscribe to the event using the EventHelper's on method\n        (convoAPI as any).on(\n          EConversationalAIAPIEvents.TRANSCRIPT_UPDATED,\n          transcriptHandler\n        );\n      } catch (error) {\n        console.error(\"Toolkit init error:\", error);\n      }\n    };\n\n    initToolkit();\n\n    return () => {\n      isMounted = false;\n      if (convoApiRef.current) {\n        try {\n          // Remove all event listeners before cleanup\n          (convoApiRef.current as any).removeAllEventListeners();\n          // Note: unsubscribe is async but cleanup can't be async, so we call it without await\n          convoApiRef.current.unsubscribe().catch(() => {\n            // Ignore unsubscribe errors in cleanup\n          });\n          convoApiRef.current.destroy();\n        } catch (e) {\n          // Ignore cleanup errors\n        }\n        convoApiRef.current = null;\n      }\n      if (rtmClientRef.current) {\n        rtmClientRef.current.logout().catch(() => {});\n        rtmClientRef.current = null;\n      }\n    };\n  }, [agoraConfig, agora?.client]);\n\n  const sendMessage = async () => {\n    if (!input.trim() || isLoading || !convoApiRef.current || !agentId) return;\n\n    const userMessage = input;\n    setInput(\"\");\n    setIsLoading(true);\n    setWaitingForAgent(true); // Start waiting for agent response\n\n    // Add a loading indicator (3 dots) instead of the actual message\n    // The actual message will come from the transcription event\n    const loadingTimestamp = Date.now();\n    setMessages((prev) => {\n      const loadingMsg: ChatMessage = {\n        role: \"user\",\n        content: \"\", // Empty content, will show loading animation\n        uid: agoraConfig?.rtmUserId,\n        turnId: -1, // Temporary ID for loading message\n        turn_id: -1,\n        timestamp: loadingTimestamp,\n        isLoading: true, // Flag to show loading animation\n      };\n\n      // Add to end and sort to maintain order\n      const updated = [...prev, loadingMsg].sort((a, b) => {\n        const timestampA = a.timestamp || 0;\n        const timestampB = b.timestamp || 0;\n        if (timestampA !== timestampB) return timestampA - timestampB;\n        const turnIdA = a.turnId || a.turn_id || 0;\n        const turnIdB = b.turnId || b.turn_id || 0;\n        return turnIdA - turnIdB;\n      });\n      return updated;\n    });\n\n    try {\n      // Use toolkit's sendText method\n      const message: IChatMessageText = {\n        messageType: EChatMessageType.TEXT,\n        text: userMessage,\n        priority: EChatMessagePriority.INTERRUPTED,\n        responseInterruptable: true,\n      };\n      await convoApiRef.current.sendText(\"1000\", message);\n      setIsLoading(false);\n      // Keep waitingForAgent true until agent responds\n    } catch (error: any) {\n      console.error(\"Chat error:\", error);\n      console.error(\"Error details:\", error?.message, error?.stack);\n      // Remove loading message on error\n      setMessages((prev) => prev.filter((msg) => !msg.isLoading));\n      setMessages((prev) => [\n        ...prev,\n        {\n          role: \"assistant\",\n          content: \"Sorry, I encountered an error. Please try again.\",\n        },\n      ]);\n      setIsLoading(false);\n      setWaitingForAgent(false);\n    }\n  };\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  };\n\n  const handleEndCall = async () => {\n    // Call leave endpoint for the Agora Conversational AI agent\n    if (agentId) {\n      try {\n        await fetch(\"/api/agora/leave-agent\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ agentId }),\n        });\n      } catch (e) {\n        // Ignore errors when leaving agent\n      }\n    }\n\n    if (agora) {\n      agora.leave();\n    }\n    if (convoApiRef.current) {\n      try {\n        await convoApiRef.current.unsubscribe();\n        convoApiRef.current.destroy();\n      } catch (e) {\n        // Ignore cleanup errors\n      }\n      convoApiRef.current = null;\n    }\n    if (rtmClientRef.current) {\n      rtmClientRef.current.logout().catch(() => {});\n      rtmClientRef.current = null;\n    }\n    onClose();\n  };\n\n  const handleClose = () => {\n    handleEndCall();\n  };\n\n  const handleToggleMute = () => {\n    if (agora) {\n      agora.toggleMute();\n    }\n  };\n\n  const handleAgentVolumeChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const newVolume = parseInt(e.target.value);\n    setAgentVolume(newVolume);\n    if (agora?.remoteAudioTrack) {\n      agora.remoteAudioTrack.setVolume(newVolume);\n    }\n  };\n\n  const handleVolumeMin = () => {\n    setAgentVolume(0);\n    if (agora?.remoteAudioTrack) {\n      agora.remoteAudioTrack.setVolume(0);\n    }\n  };\n\n  const handleVolumeMax = () => {\n    setAgentVolume(100);\n    if (agora?.remoteAudioTrack) {\n      agora.remoteAudioTrack.setVolume(100);\n    }\n  };\n\n  // Handle microphone change\n  const handleMicrophoneChange = async (\n    e: React.ChangeEvent<HTMLSelectElement>\n  ) => {\n    const deviceId = e.target.value;\n    if (!agora?.localAudioTrack) {\n      console.error(\"Local audio track not available\");\n      return;\n    }\n\n    const previousDeviceId = selectedMicrophone;\n    setSelectedMicrophone(deviceId);\n\n    try {\n      // Use setDevice method on the microphone audio track\n      await agora.localAudioTrack.setDevice(deviceId);\n      console.log(\"Microphone changed to:\", deviceId);\n    } catch (error) {\n      console.error(\"Error setting microphone:\", error);\n      // Revert selection on error\n      setSelectedMicrophone(previousDeviceId);\n    }\n  };\n\n  return (\n    <>\n      {/* Video Container - Always visible, positioned directly on top of chat or minimized button */}\n      {agora?.remoteVideoTrack && (\n        <div \n          ref={videoContainerRef}\n          className={`fixed w-80 h-[240px]`}\n          style={{ \n            zIndex: 45, // Lower z-index so buttons (z-50+) are always clickable\n            // Position directly on top with no gap\n            // Chat container: bottom-6 (24px) + h-[400px] = top edge at 424px\n            // Overlap by 30px to compensate for video/canvas gap when expanded\n            // When minimized: button is at bottom-6 (24px), button is ~40-50px tall, so top is at ~64-74px\n            // Overlap by 40px (30px + 10px more) to compensate for canvas/video gap\n            // When minimized, center Effie over the button\n            // Button is at right-6 (24px = 1.5rem), button is ~180px wide\n            // To perfectly center: button center is at 24px + 90px = 114px from right\n            // Effie (320px wide) center should be at 114px from right\n            // So Effie's right edge = 114px + 160px = 274px from right\n            // But since Effie is wider, align right edges and use transform to shift left\n            bottom: isMinimized ? '34px' : '394px',\n            right: isMinimized ? '1.5rem' : '1.5rem', // Align right edge with button\n            transform: isMinimized ? 'translateX(70px)' : 'none', // Shift right by 70px to center\n            pointerEvents: 'none' // Always allow clicks through so buttons are clickable\n          }}\n        >\n          <canvas\n            ref={canvasRef}\n            className=\"w-full h-full object-contain\"\n            style={{ backgroundColor: 'transparent', display: 'block' }}\n          />\n        </div>\n      )}\n\n      {isMinimized ? (\n        <div className=\"fixed bottom-6 right-6 z-50\">\n          <button\n            onClick={() => setIsMinimized(false)}\n            className=\"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl shadow-lg flex items-center gap-2 text-sm font-medium transition\"\n          >\n            <div className=\"relative\">\n              <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path d=\"M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z\" />\n                <path d=\"M19 10v1a7 7 0 0 1-14 0v-1M12 18v4M8 22h8\" />\n              </svg>\n              {agora?.isConnected && (\n                <div className=\"absolute -top-0.5 -right-0.5 w-2 h-2 bg-green-400 rounded-full border border-white animate-pulse\"></div>\n              )}\n            </div>\n            <span>AI Assistant</span>\n            {agora?.isConnected && (\n              <span className=\"text-xs bg-green-500 px-2 py-0.5 rounded-full\">\n                Active\n              </span>\n            )}\n          </button>\n        </div>\n      ) : (\n        <div className=\"fixed bottom-6 right-6 z-50 w-80\">\n      \n      <div className=\"bg-white rounded-xl shadow-2xl border border-gray-200 h-[400px] flex flex-col overflow-hidden relative\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between p-2.5 border-b border-gray-200 bg-white\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"relative\">\n              <div\n                className={`w-8 h-8 rounded-full flex items-center justify-center ${\n                  agora?.isConnected ? \"bg-green-100\" : \"bg-gray-100\"\n                }`}\n              >\n                <svg\n                  className={`w-4 h-4 ${\n                    agora?.isConnected ? \"text-green-600\" : \"text-gray-400\"\n                  }`}\n                  fill=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                >\n                  <path d=\"M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z\" />\n                  <path d=\"M19 10v1a7 7 0 0 1-14 0v-1M12 18v4M8 22h8\" />\n                </svg>\n              </div>\n              {agora?.isConnected && (\n                <div className=\"absolute -top-0.5 -right-0.5 w-2 h-2 bg-green-500 rounded-full border border-white\"></div>\n              )}\n            </div>\n            <div>\n              <h3 className=\"text-xs font-semibold text-gray-900\">\n                AI Assistant\n              </h3>\n              {isInitializing ? (\n                <span className=\"text-[10px] text-gray-500\">Connecting...</span>\n              ) : agora?.isConnected ? (\n                <span className=\"text-[10px] text-green-600 font-medium\">\n                  Active\n                </span>\n              ) : (\n                <span className=\"text-[10px] text-gray-500\">Ready</span>\n              )}\n            </div>\n          </div>\n          <div className=\"flex items-center gap-1.5\">\n            <button\n              onClick={() => setIsMinimized(true)}\n              className=\"p-1.5 hover:bg-gray-100 rounded-lg transition text-gray-600\"\n              title=\"Minimize\"\n              aria-label=\"Minimize\"\n            >\n              <svg\n                className=\"w-3.5 h-3.5\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M20 12H4\"\n                />\n              </svg>\n            </button>\n            <button\n              onClick={handleEndCall}\n              disabled={isInitializing}\n              className=\"bg-red-500 hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-3 py-1.5 rounded-lg transition font-medium flex items-center justify-center gap-1.5 text-xs relative\"\n              style={{ zIndex: 60 }}\n              title=\"End conversation\"\n              aria-label=\"End conversation\"\n            >\n              <svg\n                className=\"w-3.5 h-3.5\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M16 8l-8 8m0 0l-2-2m2 2l2-2\"\n                />\n              </svg>\n              <span>End</span>\n            </button>\n          </div>\n        </div>\n\n        {/* Messages */}\n        <div className=\"flex-1 overflow-y-auto p-2.5 space-y-2 bg-gray-50 text-xs\">\n          {messages.map((msg, idx) => (\n            <div\n              key={idx}\n              className={`flex ${\n                msg.role === \"user\" ? \"justify-end\" : \"justify-start\"\n              }`}\n            >\n              <div\n                className={`max-w-[85%] rounded-lg px-3 py-1.5 ${\n                  msg.role === \"user\"\n                    ? \"bg-blue-600 text-white\"\n                    : \"bg-white text-gray-800 shadow-sm border border-gray-100\"\n                }`}\n              >\n                {msg.isLoading ? (\n                  <div className=\"flex gap-1\">\n                    <div className=\"w-1.5 h-1.5 bg-current rounded-full animate-bounce opacity-75\"></div>\n                    <div\n                      className=\"w-1.5 h-1.5 bg-current rounded-full animate-bounce opacity-75\"\n                      style={{ animationDelay: \"0.1s\" }}\n                    ></div>\n                    <div\n                      className=\"w-1.5 h-1.5 bg-current rounded-full animate-bounce opacity-75\"\n                      style={{ animationDelay: \"0.2s\" }}\n                    ></div>\n                  </div>\n                ) : (\n                  <p className=\"text-xs leading-relaxed whitespace-pre-wrap\">\n                    {msg.content}\n                  </p>\n                )}\n              </div>\n            </div>\n          ))}\n          {/* Show loading indicator when waiting for agent response */}\n          {waitingForAgent && (\n            <div className=\"flex justify-start\">\n              <div className=\"bg-white text-gray-800 rounded-lg px-3 py-1.5 shadow-sm border border-gray-100\">\n                <div className=\"flex gap-1\">\n                  <div className=\"w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce\"></div>\n                  <div\n                    className=\"w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce\"\n                    style={{ animationDelay: \"0.1s\" }}\n                  ></div>\n                  <div\n                    className=\"w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce\"\n                    style={{ animationDelay: \"0.2s\" }}\n                  ></div>\n                </div>\n              </div>\n            </div>\n          )}\n          <div ref={messagesEndRef} />\n        </div>\n\n        {/* Input Area - Compact Design */}\n        <div className=\"p-2.5 border-t border-gray-200 bg-white space-y-2\">\n          {/* Mute Button and Volume Control - Same Line */}\n          <div className=\"flex items-center gap-1.5\">\n            {/* Mute Button - Icon Only */}\n            <button\n              onClick={handleToggleMute}\n              disabled={!agora?.isConnected || isInitializing}\n              className={`p-1.5 rounded-lg transition ${\n                agora?.isMuted\n                  ? \"bg-red-100 text-red-700 hover:bg-red-200\"\n                  : \"bg-blue-100 text-blue-700 hover:bg-blue-200\"\n              } disabled:opacity-50 disabled:cursor-not-allowed`}\n              title={agora?.isMuted ? \"Unmute microphone\" : \"Mute microphone\"}\n              aria-label={agora?.isMuted ? \"Unmute\" : \"Mute\"}\n            >\n              <svg\n                className=\"w-3.5 h-3.5\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                {agora?.isMuted ? (\n                  <>\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={2}\n                      d=\"M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z\"\n                    />\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={2}\n                      d=\"M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2\"\n                    />\n                  </>\n                ) : (\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z\"\n                  />\n                )}\n              </svg>\n            </button>\n\n            {/* Agent Volume Control */}\n            <button\n              onClick={handleVolumeMin}\n              disabled={!agora?.isConnected || isInitializing}\n              className=\"p-1 rounded transition text-gray-500 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed\"\n              title=\"Volume 0\"\n              aria-label=\"Set volume to 0\"\n            >\n              <svg\n                className=\"w-3 h-3\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z\"\n                />\n              </svg>\n            </button>\n            <input\n              type=\"range\"\n              min=\"0\"\n              max=\"100\"\n              value={agentVolume}\n              onChange={handleAgentVolumeChange}\n              disabled={!agora?.isConnected || isInitializing}\n              className=\"flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed\"\n              title={`Agent volume: ${agentVolume}%`}\n            />\n            <button\n              onClick={handleVolumeMax}\n              disabled={!agora?.isConnected || isInitializing}\n              className=\"p-1 rounded transition text-gray-500 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed\"\n              title=\"Volume 100\"\n              aria-label=\"Set volume to 100\"\n            >\n              <svg\n                className=\"w-4 h-4\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z\"\n                />\n              </svg>\n            </button>\n          </div>\n\n          {/* Text Input - Always Visible */}\n          <div className=\"flex gap-1.5\">\n            <input\n              type=\"text\"\n              value={input}\n              onChange={(e) => setInput(e.target.value)}\n              onKeyPress={handleKeyPress}\n              className=\"flex-1 border border-gray-200 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 bg-gray-50\"\n              disabled={isLoading || isInitializing || !convoApiRef.current}\n              placeholder=\"Type a message...\"\n            />\n            <button\n              onClick={sendMessage}\n              disabled={\n                isLoading ||\n                !input.trim() ||\n                isInitializing ||\n                !convoApiRef.current ||\n                !agentId\n              }\n              className=\"bg-gray-700 hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-3 py-1.5 rounded-lg text-xs transition font-medium\"\n              title={\n                !convoApiRef.current || !agentId\n                  ? \"Waiting for agent to be ready...\"\n                  : \"\"\n              }\n            >\n              Send\n            </button>\n          </div>\n\n          {/* Audio Settings - Collapsible */}\n          <details className=\"group\">\n            <summary className=\"cursor-pointer text-[10px] text-gray-500 hover:text-gray-700 flex items-center gap-1\">\n              <svg\n                className=\"w-2.5 h-2.5 transition-transform group-open:rotate-90\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M9 5l7 7-7 7\"\n                />\n              </svg>\n              Audio settings\n            </summary>\n            <div className=\"mt-1.5 pt-1.5 border-t border-gray-100\">\n              <label className=\"block text-[10px] text-gray-600 mb-1\">\n                Microphone\n              </label>\n              <select\n                value={selectedMicrophone}\n                onChange={handleMicrophoneChange}\n                disabled={!agora?.isConnected || isInitializing}\n                className=\"w-full text-xs border border-gray-200 rounded-lg px-2 py-1.5 bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent disabled:opacity-50\"\n              >\n                {microphones.map((mic) => (\n                  <option key={mic.deviceId} value={mic.deviceId}>\n                    {mic.label || `Microphone ${mic.deviceId.slice(0, 8)}`}\n                  </option>\n                ))}\n              </select>\n            </div>\n          </details>\n        </div>\n      </div>\n    </div>\n      )}\n    </>\n  );\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3582, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/components/AIAssistant.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\nimport { ChatInterface } from \"./ChatInterface\";\n\ninterface Product {\n  id: string;\n  name: string;\n  price: number;\n  rating: number;\n  description: string;\n  reviews: any[];\n}\n\ninterface AIAssistantProps {\n  product: Product;\n}\n\nexport function AIAssistant({ product }: AIAssistantProps) {\n  const [isOpen, setIsOpen] = useState(false);\n\n  return (\n    <>\n      {/* Floating Button - Hidden when chat is open */}\n      {!isOpen && (\n        <button\n          onClick={() => setIsOpen(true)}\n          className=\"fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition hover:scale-110 z-50 flex items-center justify-center group\"\n          aria-label=\"Open AI Voice Assistant\"\n          title=\"Talk to AI Assistant\"\n        >\n          {/* Microphone icon with sound waves */}\n          <div className=\"relative\">\n            <svg\n              className=\"w-6 h-6\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z\"\n              />\n            </svg>\n            {/* Animated sound waves */}\n            <div className=\"absolute inset-0 flex items-center justify-center\">\n              <div className=\"absolute w-8 h-8 border-2 border-white rounded-full opacity-0 group-hover:opacity-100 group-hover:animate-ping\"></div>\n              <div\n                className=\"absolute w-10 h-10 border-2 border-white rounded-full opacity-0 group-hover:opacity-50 group-hover:animate-ping\"\n                style={{ animationDelay: \"0.2s\" }}\n              ></div>\n            </div>\n          </div>\n        </button>\n      )}\n\n      {/* Chat Interface Modal */}\n      {isOpen && (\n        <ChatInterface product={product} onClose={() => setIsOpen(false)} />\n      )}\n    </>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;;;AAHA;;;AAkBO,SAAS,YAAY,EAAE,OAAO,EAAoB;;IACvD,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,yKAAQ,EAAC;IAErC,qBACE;;YAEG,CAAC,wBACA,6LAAC;gBACC,SAAS,IAAM,UAAU;gBACzB,WAAU;gBACV,cAAW;gBACX,OAAM;0BAGN,cAAA,6LAAC;oBAAI,WAAU;;sCACb,6LAAC;4BACC,WAAU;4BACV,MAAK;4BACL,QAAO;4BACP,SAAQ;sCAER,cAAA,6LAAC;gCACC,eAAc;gCACd,gBAAe;gCACf,aAAa;gCACb,GAAE;;;;;;;;;;;sCAIN,6LAAC;4BAAI,WAAU;;8CACb,6LAAC;oCAAI,WAAU;;;;;;8CACf,6LAAC;oCACC,WAAU;oCACV,OAAO;wCAAE,gBAAgB;oCAAO;;;;;;;;;;;;;;;;;;;;;;;YAQzC,wBACC,6LAAC,gJAAa;gBAAC,SAAS;gBAAS,SAAS,IAAM,UAAU;;;;;;;;AAIlE;GA9CgB;KAAA"}},
    {"offset": {"line": 3686, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/components/AgoraBranding.tsx"],"sourcesContent":["// Agora Branding Component\nexport function AgoraLogo({ className = \"h-4\" }: { className?: string }) {\n  return (\n    <svg\n      viewBox=\"0 0 399.34668 137.06667\"\n      className={className}\n      role=\"img\"\n      aria-label=\"Agora\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n      fill=\"currentColor\"\n    >\n      <path\n        d=\"m 1676.5,1027.77 c -168.56,0 -305.69,-137.129 -305.69,-305.68 0,-168.551 137.13,-305.672 305.69,-305.672 168.55,0 305.66,137.121 305.66,305.672 0,168.551 -137.11,305.68 -305.66,305.68 m 0,-474.231 c -92.95,0 -168.56,75.609 -168.56,168.551 0,92.937 75.61,168.551 168.56,168.551 92.93,0 168.55,-75.614 168.55,-168.551 0,-92.942 -75.62,-168.551 -168.55,-168.551\"\n        fill=\"currentColor\"\n        fillRule=\"nonzero\"\n        transform=\"matrix(0.13333333,0,0,-0.13333333,0,137.06667)\"\n      />\n      <path\n        d=\"m 2185.11,949.031 -3.85,-3.722 -4.07,-3.938 -2.68,4.988 -2.54,4.723 c -22.03,40.938 -62.59,69.108 -108.49,75.338 l -11.34,1.54 V 416.219 l 11.43,1.66 c 62.57,9.09 125.7,57.109 125.7,143.91 v 160.27 c 0,85.332 66.43,158.98 151.23,167.671 l 8.98,0.918 v 137.222 l -10.97,-1.07 c -53.18,-5.22 -106.22,-32.109 -153.4,-77.769\"\n        fill=\"currentColor\"\n        fillRule=\"nonzero\"\n        transform=\"matrix(0.13333333,0,0,-0.13333333,0,137.06667)\"\n      />\n      <path\n        d=\"m 501.902,967.207 -2.422,-3.363 -2.57,-3.547 -3.5,2.648 -3.301,2.512 C 436.578,1006.09 372.801,1027.57 305.68,1027.57 137.129,1027.57 0,890.438 0,721.887 0,553.336 137.129,416.203 305.68,416.203 c 67.121,0 130.89,21.481 184.41,62.121 l 3.32,2.512 3.492,2.648 2.567,-3.55 2.433,-3.36 c 23.231,-32.097 58.989,-53.597 98.098,-59 l 11.359,-1.558 V 1027.77 L 600,1026.21 c -39.109,-5.39 -74.867,-26.905 -98.098,-59.003 M 305.68,553.336 c -92.942,0 -168.551,75.609 -168.551,168.551 0,92.937 75.609,168.551 168.551,168.551 92.941,0 168.55,-75.614 168.55,-168.551 0,-92.942 -75.609,-168.551 -168.55,-168.551\"\n        fill=\"currentColor\"\n        fillRule=\"nonzero\"\n        transform=\"matrix(0.13333333,0,0,-0.13333333,0,137.06667)\"\n      />\n      <path\n        d=\"m 2983.74,1026.2 c -39.11,-5.4 -74.86,-26.899 -98.09,-58.997 l -2.43,-3.351 -2.57,-3.559 -3.49,2.66 -3.31,2.508 c -53.52,40.629 -117.3,62.109 -184.43,62.109 -168.55,0 -305.67,-137.129 -305.67,-305.679 0,-168.547 137.12,-305.68 305.67,-305.68 67.13,0 130.91,21.48 184.44,62.109 l 3.3,2.512 3.49,2.648 2.57,-3.546 2.43,-3.364 c 23.23,-32.097 58.98,-53.597 98.09,-59 l 11.36,-1.558 V 1027.76 Z M 2689.42,553.344 c -92.93,0 -168.55,75.609 -168.55,168.547 0,92.941 75.62,168.55 168.55,168.55 92.94,0 168.55,-75.609 168.55,-168.55 0,-92.938 -75.61,-168.547 -168.55,-168.547\"\n        fill=\"currentColor\"\n        fillRule=\"nonzero\"\n        transform=\"matrix(0.13333333,0,0,-0.13333333,0,137.06667)\"\n      />\n      <path\n        d=\"m 1186.88,483.656 c 69.87,56.071 114.72,142.086 114.72,238.438 0,63.441 -19.44,122.422 -52.66,171.32 -4.43,6.52 -9.19,12.789 -14.09,18.941 37.55,23.829 59.28,64.008 65.09,103.985 l 1.66,11.43 H 994.605 v -0.04 C 826.664,1027.02 690.254,890.195 690.254,722.094 c 0,-96.36 44.859,-182.391 114.75,-238.461 -13.117,-10.528 -25.391,-22.059 -36.609,-34.57 l 93.23,-102.161 c 30.809,40.59 79.539,66.864 134.309,66.864 92.936,0 168.546,-75.614 168.546,-168.551 0,-60.27 -31.82,-113.223 -79.52,-143.02 L 1178.22,0 c 74.83,55.7734 123.38,144.926 123.38,245.215 0,96.348 -44.85,182.367 -114.72,238.441 M 995.813,890.637 h 0.242 c 92.875,-0.063 168.425,-75.645 168.425,-168.543 0,-92.942 -75.61,-168.551 -168.546,-168.551 -92.942,0 -168.551,75.609 -168.551,168.551 0,92.898 75.543,168.48 168.43,168.543\"\n        fill=\"currentColor\"\n        fillRule=\"nonzero\"\n        transform=\"matrix(0.13333333,0,0,-0.13333333,0,137.06667)\"\n      />\n    </svg>\n  );\n}\n\nexport function AgoraBranding({ variant = \"header\" }: { variant?: \"header\" | \"badge\" | \"footer\" }) {\n  if (variant === \"badge\") {\n    return (\n      <div className=\"flex items-center gap-1.5 px-2 py-1 bg-white/80 backdrop-blur-sm rounded-lg border border-gray-200\">\n        <div className=\"text-[#0093E9]\">\n          <AgoraLogo className=\"h-3\" />\n        </div>\n        <span className=\"text-[10px] text-gray-600 font-medium\">\n          Convo AI\n        </span>\n      </div>\n    );\n  }\n\n  if (variant === \"footer\") {\n    return (\n      <div className=\"flex items-center justify-center gap-2 py-3 border-t border-gray-200 bg-gray-50\">\n        <span className=\"text-xs text-gray-500\">Powered by</span>\n        <a\n          href=\"https://www.agora.io\"\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"flex items-center text-[#0093E9] hover:text-[#34b7ee] transition-colors duration-200\"\n        >\n          <AgoraLogo className=\"h-4\" />\n        </a>\n        <span className=\"text-xs text-gray-600 font-medium\">Conversational AI</span>\n      </div>\n    );\n  }\n\n  // Header variant (default)\n  return (\n    <a\n      href=\"https://www.agora.io\"\n      target=\"_blank\"\n      rel=\"noopener noreferrer\"\n      className=\"flex items-center gap-2 text-[#0093E9] hover:text-[#34b7ee] transition-colors duration-200\"\n    >\n      <AgoraLogo className=\"h-5\" />\n      <div className=\"flex flex-col\">\n        <span className=\"text-xs font-semibold text-gray-900\">Conversational AI</span>\n        <span className=\"text-[10px] text-gray-500\">Powered by Agora</span>\n      </div>\n    </a>\n  );\n}\n\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;;;;;AACpB,SAAS,UAAU,EAAE,YAAY,KAAK,EAA0B;IACrE,qBACE,6LAAC;QACC,SAAQ;QACR,WAAW;QACX,MAAK;QACL,cAAW;QACX,OAAM;QACN,MAAK;;0BAEL,6LAAC;gBACC,GAAE;gBACF,MAAK;gBACL,UAAS;gBACT,WAAU;;;;;;0BAEZ,6LAAC;gBACC,GAAE;gBACF,MAAK;gBACL,UAAS;gBACT,WAAU;;;;;;0BAEZ,6LAAC;gBACC,GAAE;gBACF,MAAK;gBACL,UAAS;gBACT,WAAU;;;;;;0BAEZ,6LAAC;gBACC,GAAE;gBACF,MAAK;gBACL,UAAS;gBACT,WAAU;;;;;;0BAEZ,6LAAC;gBACC,GAAE;gBACF,MAAK;gBACL,UAAS;gBACT,WAAU;;;;;;;;;;;;AAIlB;KA1CgB;AA4CT,SAAS,cAAc,EAAE,UAAU,QAAQ,EAA+C;IAC/F,IAAI,YAAY,SAAS;QACvB,qBACE,6LAAC;YAAI,WAAU;;8BACb,6LAAC;oBAAI,WAAU;8BACb,cAAA,6LAAC;wBAAU,WAAU;;;;;;;;;;;8BAEvB,6LAAC;oBAAK,WAAU;8BAAwC;;;;;;;;;;;;IAK9D;IAEA,IAAI,YAAY,UAAU;QACxB,qBACE,6LAAC;YAAI,WAAU;;8BACb,6LAAC;oBAAK,WAAU;8BAAwB;;;;;;8BACxC,6LAAC;oBACC,MAAK;oBACL,QAAO;oBACP,KAAI;oBACJ,WAAU;8BAEV,cAAA,6LAAC;wBAAU,WAAU;;;;;;;;;;;8BAEvB,6LAAC;oBAAK,WAAU;8BAAoC;;;;;;;;;;;;IAG1D;IAEA,2BAA2B;IAC3B,qBACE,6LAAC;QACC,MAAK;QACL,QAAO;QACP,KAAI;QACJ,WAAU;;0BAEV,6LAAC;gBAAU,WAAU;;;;;;0BACrB,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAK,WAAU;kCAAsC;;;;;;kCACtD,6LAAC;wBAAK,WAAU;kCAA4B;;;;;;;;;;;;;;;;;;AAIpD;MA9CgB"}},
    {"offset": {"line": 3897, "column": 0}, "map": {"version":3,"sources":["file:///Users/jalbo/Desktop/dev/blog/convoAI_ecommerce/components/ProductPage.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { ProductImages } from \"./ProductImages\";\nimport { ProductReviews } from \"./ProductReviews\";\nimport { AIAssistant } from \"./AIAssistant\";\nimport { AgoraBranding } from \"./AgoraBranding\";\nimport { useCredentials } from \"@/hooks/useCredentials\";\nimport SettingsModal from \"./SettingsModal\";\nimport { AllCredentials } from \"@/lib/types/credentials\";\n\nconst fetchProduct = async (productId: string) => {\n  const res = await fetch(`/api/product?productId=${productId}`);\n  return res.json();\n};\n\nexport function ProductPage() {\n  const [product, setProduct] = useState<any>(null);\n  const [products, setProducts] = useState<any[]>([]);\n  const [selectedProductId, setSelectedProductId] = useState<string>('1');\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<any>(null);\n\n  // Load all products for selector\n  useEffect(() => {\n    fetchAllProducts()\n      .then((data) => {\n        setProducts(data);\n      })\n      .catch((err) => {\n        console.error(\"Error loading products:\", err);\n      });\n  }, []);\n\n  // Load selected product\n  useEffect(() => {\n    setIsLoading(true);\n    fetchProduct(selectedProductId)\n      .then((data) => {\n        setProduct(data);\n        setIsLoading(false);\n      })\n      .catch((err) => {\n        setError(err);\n        setIsLoading(false);\n      });\n  }, [selectedProductId]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex justify-center items-center h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"></div>\n          <div className=\"text-xl font-medium text-gray-700\">Loading product...</div>\n        </div>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"flex justify-center items-center h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50\">\n        <div className=\"text-center\">\n          <div className=\"text-4xl mb-4\">⚠️</div>\n          <div className=\"text-xl font-medium text-red-600\">Error loading product</div>\n          <p className=\"text-gray-500 mt-2\">Please try again later</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!product) return null;\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50\">\n      {/* Agora Branding Header */}\n      <div className=\"bg-white border-b border-gray-200 shadow-sm\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <AgoraBranding variant=\"header\" />\n            <div className=\"text-xs text-gray-500\">\n              E-commerce Demo\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        {/* Product Selector */}\n        {products.length > 0 && (\n          <div className=\"bg-white rounded-xl shadow-md border border-gray-100 p-5 mb-8\">\n            <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n              <div>\n                <label htmlFor=\"product-select\" className=\"block text-sm font-semibold text-gray-900 mb-1\">\n                  Choose a product to explore\n                </label>\n                <p className=\"text-xs text-gray-500\">Switch between products to see how Katya helps with each one</p>\n              </div>\n              <select\n                id=\"product-select\"\n                value={selectedProductId}\n                onChange={(e) => setSelectedProductId(e.target.value)}\n                className=\"px-5 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white font-medium text-gray-900 transition-all hover:border-gray-300\"\n              >\n                {products.map((p) => (\n                  <option key={p.id} value={p.id}>\n                    {p.name} - ${p.price}\n                  </option>\n                ))}\n              </select>\n            </div>\n          </div>\n        )}\n\n        {/* Product Header */}\n        <div className=\"bg-white rounded-xl shadow-md border border-gray-100 p-8 mb-8\">\n          <h1 className=\"text-4xl font-bold text-gray-900 mb-4\">\n            {product.name}\n          </h1>\n          <div className=\"flex flex-wrap items-center gap-4 mb-6\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"flex\">\n                {[...Array(5)].map((_, i) => (\n                  <svg\n                    key={i}\n                    className={`w-5 h-5 ${\n                      i < Math.floor(product.rating)\n                        ? \"text-yellow-400 fill-current\"\n                        : \"text-gray-300\"\n                    }`}\n                    viewBox=\"0 0 20 20\"\n                  >\n                    <path d=\"M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z\" />\n                  </svg>\n                ))}\n              </div>\n              <span className=\"text-lg font-semibold text-gray-900\">\n                {product.rating}\n              </span>\n              <span className=\"text-sm text-gray-500\">\n                ({product.reviewCount.toLocaleString()} reviews)\n              </span>\n            </div>\n            {product.inStock && (\n              <span className=\"px-4 py-1.5 bg-emerald-100 text-emerald-800 rounded-full text-sm font-semibold border border-emerald-200\">\n                ✓ In Stock\n              </span>\n            )}\n          </div>\n          <div className=\"flex flex-wrap items-baseline gap-4\">\n            <span className=\"text-5xl font-bold text-gray-900\">\n              ${product.price}\n            </span>\n            <span className=\"text-2xl text-gray-400 line-through\">\n              ${product.originalPrice}\n            </span>\n            <span className=\"px-3 py-1.5 bg-red-50 text-red-700 rounded-lg text-sm font-semibold border border-red-200\">\n              Save {product.discount}%\n            </span>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8\">\n          {/* Product Images */}\n          <ProductImages images={product.images} />\n\n          {/* Product Details */}\n          <div className=\"bg-white rounded-xl shadow-md border border-gray-100 p-8\">\n            <h2 className=\"text-3xl font-bold text-gray-900 mb-6\">Product Details</h2>\n            <p className=\"text-gray-700 mb-8 leading-relaxed text-lg\">\n              {product.description}\n            </p>\n\n            <div className=\"border-t border-gray-200 pt-6 mb-6\">\n              <h3 className=\"text-2xl font-bold text-gray-900 mb-4\">Specifications</h3>\n              <dl className=\"space-y-4\">\n                {Object.entries(product.specifications).map(([key, value]) => (\n                  <div key={key} className=\"flex flex-col sm:flex-row sm:items-start gap-2 pb-4 border-b border-gray-100 last:border-0\">\n                    <dt className=\"font-semibold text-gray-900 sm:w-48 flex-shrink-0\">{key}:</dt>\n                    <dd className=\"text-gray-600 flex-1\">{value as string}</dd>\n                  </div>\n                ))}\n              </dl>\n            </div>\n\n            <button className=\"w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 text-lg\">\n              Add to Cart\n            </button>\n          </div>\n        </div>\n\n        {/* Reviews Section */}\n        <ProductReviews reviews={product.reviews} rating={product.rating} />\n\n        {/* AI Assistant */}\n        <AIAssistant product={product} />\n\n        {/* Agora Branding Footer */}\n        <div className=\"mt-12 mb-8\">\n          <AgoraBranding variant=\"footer\" />\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}